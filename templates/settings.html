<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Settings</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
</head>
<body class="dashboard-body">
  <div class="dashboard-layout">
    <!-- Sidebar -->
    <aside class="dashboard-sidebar">
      <div class="sidebar-header">
        <div class="logo">
          <span class="logo-icon">üöö</span>
          <span class="logo-text">Admin Panel</span>
        </div>
      </div>
      <nav class="sidebar-nav">
        <ul class="nav-menu">
          <li class="nav-item">
            <a href="{{ url_for('dashboard') }}" class="nav-link">
              <span class="nav-icon">üìä</span><span class="nav-text">Dashboard</span>
            </a>
          </li>
          <li class="nav-item">
            <a href="{{ url_for('users') }}" class="nav-link">
              <span class="nav-icon">üë•</span><span class="nav-text">Users</span>
            </a>
          </li>
          <li class="nav-item">
            <a href="{{ url_for('shipments') }}" class="nav-link">
              <span class="nav-icon">üì¶</span><span class="nav-text">Shipments</span>
            </a>
          </li>
          <li class="nav-item">
            <a href="{{ url_for('admin_content_manager') }}" class="nav-link">
              <span class="nav-icon">üß©</span><span class="nav-text">Content</span>
            </a>
          </li>
          <li class="nav-item">
            <a href="{{ url_for('bookings') }}" class="nav-link">
              <span class="nav-icon">üé´</span><span class="nav-text">Bookings</span>
            </a>
          </li>
          <li class="nav-item">
            <a href="{{ url_for('analytics_page') }}" class="nav-link">
              <span class="nav-icon">üìà</span><span class="nav-text">Analytics</span>
            </a>
          </li>
          <li class="nav-item active">
            <a href="{{ url_for('settings') }}" class="nav-link">
              <span class="nav-icon">‚öôÔ∏è</span><span class="nav-text">Settings</span>
            </a>
          </li>
        </ul>
      </nav>
      <div class="sidebar-footer">
        <div class="user-profile">
          <div class="user-avatar" id="profileAvatar">A</div>
          <div class="user-info">
            <div class="user-name" id="profileName">Admin</div>
            <div class="user-role"><span id="profileEmail">admin@company.com</span></div>
          </div>
        </div>
      </div>
    </aside>

    <!-- Main -->
    <main class="dashboard-main">
      <header class="dashboard-header">
        <div class="header-left">
          <button class="sidebar-toggle" id="sidebarToggle"><span></span><span></span><span></span></button>
          <h1>Settings</h1>
        </div>
        <div class="header-right">
          <div class="datetime-display">
            <span id="current-date"></span>
            <span id="current-time"></span>
            <span id="current-day"></span>
          </div>
          <div class="header-actions">
            <!-- Notifications -->
            <div class="notification-dropdown">
              <button class="notification-btn" id="notificationBtn">üîî
                <span class="notification-badge" id="notificationBadge" style="display:none;">0</span>
              </button>
              <div class="notification-menu" id="notificationMenu">
                <div class="notification-header">
                  <h3>Notifications</h3>
                  <button class="mark-all-read-btn" id="markAllReadBtn">Mark all as read</button>
                </div>
                <div class="notification-list" id="notificationList">
                  <div class="loading-notifications">Loading notifications...</div>
                </div>
                <div class="notification-footer">
                  <button class="view-all-btn" id="viewAllNotificationsBtn">View All Notifications</button>
                </div>
              </div>
            </div>
            <!-- Profile -->
            <div class="profile-dropdown">
              <button class="profile-btn" id="profileBtn">üë§</button>
              <div class="profile-menu" id="profileMenu">
                <div class="profile-header">
                  <div class="profile-avatar-large" id="profileAvatarMenu">A</div>
                  <div class="profile-info">
                    <h3 id="profileNameMenu">Administrator</h3>
                    <p id="profileEmailMenu">admin@company.com</p>
                  </div>
                </div>
                <div class="profile-actions">
                  <a class="btn" href="{{ url_for('admin_profile') }}">Edit Profile</a>
                </div>
              </div>
            </div>
          </div>
        </div>
      </header>

      <!-- Content -->
      <div class="dashboard-content">
        <div class="card">
          <h3>General Settings</h3>
          <form class="form-grid" id="settingsForm" onsubmit="return false;">
            <div class="form-row">
              <label for="companyName">Company Name</label>
              <input id="companyName" type="text" placeholder="Enter company name">
            </div>
            <div class="form-row">
              <label for="supportEmail">Support Email</label>
              <input id="supportEmail" type="email" placeholder="support@example.com">
            </div>
            <div class="form-row">
              <label for="companyPhone">Support Phone</label>
              <input id="companyPhone" type="tel" placeholder="+94 7X XXX XXXX" pattern="^[0-9+()\s-]{6,20}$">
            </div>
            <div class="form-row">
              <label for="currency">Currency</label>
              <select id="currency">
                <option value="LKR" selected>LKR (Sri Lankan Rupee)</option>
                <option value="USD">USD</option>
              </select>
            </div>
            <div class="form-actions">
              <button class="btn" id="saveSettingsBtn" type="button">Save Settings</button>
            </div>
            <div id="settingsMsg" class="inline-status" aria-live="polite"></div>
          </form>
        </div>

        <div class="card">
          <h3>Notifications</h3>
          <div class="form-row">
            <label><input type="checkbox" id="emailNotifs" checked> Email notifications</label>
          </div>
          <div class="form-row">
            <label><input type="checkbox" id="smsNotifs"> SMS notifications</label>
          </div>
        </div>
      </div>
    </main>
  </div>

  <script>
  // Sidebar toggle
  function toggleSidebar(){
    const s=document.querySelector('.dashboard-sidebar');
    const m=document.querySelector('.dashboard-main');
    s.classList.toggle('collapsed'); m.classList.toggle('expanded');
  }

  // Date/time
  function updateDateTime(){
    try{
      const now=new Date();
      const dateOptions={year:'numeric',month:'long',day:'numeric'};
      const timeOptions={hour:'2-digit',minute:'2-digit',second:'2-digit',hour12:true};
      const dayOptions={weekday:'long'};
      const d=document.getElementById('current-date');
      const t=document.getElementById('current-time');
      const w=document.getElementById('current-day');
      if(d) d.textContent=now.toLocaleDateString('en-US',dateOptions);
      if(t) t.textContent=now.toLocaleTimeString('en-US',timeOptions);
      if(w) w.textContent=now.toLocaleDateString('en-US',dayOptions);
    }catch(e){}
  }

  // Profile dropdown
  function bindProfileDropdown(){
    const btn=document.getElementById('profileBtn');
    const menu=document.getElementById('profileMenu');
    if(btn && menu){
      btn.addEventListener('click', (e)=>{ e.stopPropagation(); menu.classList.toggle('show'); });
    }
  }

  // Notifications
  function bindNotifications(){
    const btn=document.getElementById('notificationBtn');
    const menu=document.getElementById('notificationMenu');
    const markAll=document.getElementById('markAllReadBtn');
    const viewAll=document.getElementById('viewAllNotificationsBtn');
    function updateBadge(count){
      const badge=document.getElementById('notificationBadge');
      if(!badge) return;
      if(count>0){ badge.textContent=count>99?'99+':count; badge.style.display='block'; }
      else { badge.style.display='none'; }
    }
    async function loadList(){
      try{
        const res=await fetch('/api/notifications');
        const data=await res.json();
        updateBadge(data.unread_count||0);
        const list=document.getElementById('notificationList');
        const items=data.notifications||[];
        if(!items.length){ list.innerHTML='<div class="no-notifications">No notifications</div>'; return; }
        list.innerHTML=items.map(n=>`
          <div class="notification-item ${n.is_read?'read':'unread'}">
            <div class="notification-icon">${n.type==='booking'?'üì¶':(n.type==='shipment'?'üöö':(n.type==='message'?'üí¨':'üîî'))}</div>
            <div class="notification-content">
              <div class="notification-title">${n.title}</div>
              <div class="notification-message">${n.message}</div>
              <div class="notification-time">${n.created_at_human||''}</div>
            </div>
          </div>`).join('');
      }catch(e){
        document.getElementById('notificationList').innerHTML='<div class="error">Failed to load</div>';
      }
    }
    if(btn && menu){
      btn.addEventListener('click', async (e)=>{
        e.stopPropagation();
        const visible=menu.classList.contains('show');
        if(!visible){ menu.classList.add('show'); document.getElementById('notificationList').innerHTML='<div class="loading-notifications">Loading notifications...</div>'; await loadList(); }
        else { menu.classList.remove('show'); }
      });
    }
    if(markAll){
      markAll.addEventListener('click', async (e)=>{
        e.stopPropagation();
        try{ await fetch('/api/notifications/mark-all-read', {method:'POST'}); await loadList(); }catch(e){}
      });
    }
    if(viewAll){ viewAll.addEventListener('click', ()=> window.location.href='/notifications'); }
  }

  // Global closes
  function bindGlobalClose(){
    document.addEventListener('click', (e)=>{
      const pm=document.getElementById('profileMenu');
      const pd=document.querySelector('.profile-dropdown');
      if(pm && pd && !pd.contains(e.target)) pm.classList.remove('show');
      const nm=document.getElementById('notificationMenu');
      const nd=document.querySelector('.notification-dropdown');
      if(nm && nd && !nd.contains(e.target)) nm.classList.remove('show');
    });
  }

  // Load admin profile info
  async function loadAdminProfile(){
    try{
      const res=await fetch('/api/admin/profile');
      const data=await res.json();
      if(data && (data.name!==undefined)){
        const name=(data.name||'').trim()||'Admin';
        const email=data.email||'';
        const avatar=(name?name[0]:'A').toUpperCase();
        const nameEl=document.getElementById('profileName'); if(nameEl) nameEl.textContent=name;
        const emailEl=document.getElementById('profileEmail'); if(emailEl) emailEl.textContent=email;
        const avatarEl=document.getElementById('profileAvatar'); if(avatarEl) avatarEl.textContent=avatar;
        const nameMenu=document.getElementById('profileNameMenu'); if(nameMenu) nameMenu.textContent=name;
        const emailMenu=document.getElementById('profileEmailMenu'); if(emailMenu) emailMenu.textContent=email;
        const avatarMenu=document.getElementById('profileAvatarMenu'); if(avatarMenu) avatarMenu.textContent=avatar;
      }
    }catch(e){}
  }

  // Settings save (placeholder)
  document.addEventListener('DOMContentLoaded', ()=>{
    const sidebarToggle=document.getElementById('sidebarToggle');
    if(sidebarToggle) sidebarToggle.addEventListener('click', toggleSidebar);

    updateDateTime(); setInterval(updateDateTime, 1000);
    bindProfileDropdown();
    bindNotifications();
    bindGlobalClose();
    loadAdminProfile();

    const saveBtn=document.getElementById('saveSettingsBtn');
    const msg=document.getElementById('settingsMsg');
    if(saveBtn && msg){
      saveBtn.addEventListener('click', async ()=>{
        try{
          saveBtn.disabled=true;
          msg.textContent='Saving...'; msg.className='inline-status';
          // TODO: POST these values to a backend endpoint if needed
          const payload={
            companyName: document.getElementById('companyName').value.trim(),
            supportEmail: document.getElementById('supportEmail').value.trim(),
            companyPhone: document.getElementById('companyPhone').value.trim(),
            currency: document.getElementById('currency').value,
            emailNotifs: document.getElementById('emailNotifs')?.checked || false,
            smsNotifs: document.getElementById('smsNotifs')?.checked || false
          };
          // await fetch('/api/settings', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
          setTimeout(()=>{ msg.textContent='Settings saved successfully'; msg.className='inline-status success'; saveBtn.disabled=false; }, 500);
        }catch(e){
          msg.textContent='Failed to save settings'; msg.className='inline-status error'; saveBtn.disabled=false;
        }
      });
    }
  });
  </script>
</body>
</html>