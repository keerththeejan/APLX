<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Shipments</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
</head>
<body class="dashboard-body">
  <div class="dashboard-layout">
    <!-- Sidebar -->
    <aside class="dashboard-sidebar">
      <div class="sidebar-header">
        <div class="logo">
          <span class="logo-icon">🚚</span>
          <span class="logo-text">Admin Panel</span>
        </div>
      </div>
      <nav class="sidebar-nav">
        <ul class="nav-menu">
          <li class="nav-item">
            <a href="{{ url_for('dashboard') }}" class="nav-link">
              <span class="nav-icon">📊</span><span class="nav-text">Dashboard</span>
            </a>
          </li>
          <li class="nav-item">
            <a href="{{ url_for('users') }}" class="nav-link">
              <span class="nav-icon">👥</span><span class="nav-text">Users</span>
            </a>
          </li>
          <li class="nav-item active">
            <a href="{{ url_for('shipments') }}" class="nav-link">
              <span class="nav-icon">📦</span><span class="nav-text">Shipments</span>
            </a>
          </li>
          <li class="nav-item">
            <a href="{{ url_for('admin_content_manager') }}" class="nav-link">
              <span class="nav-icon">🧩</span><span class="nav-text">Content</span>
            </a>
          </li>
          <li class="nav-item">
            <a href="{{ url_for('bookings') }}" class="nav-link"><span class="nav-icon">🎫</span><span class="nav-text">Bookings</span></a>
          </li>
          <li class="nav-item">
            <a href="{{ url_for('analytics_page') if url_for else '/analytics' }}" class="nav-link"><span class="nav-icon">📈</span><span class="nav-text">Analytics</span></a>
          </li>
          <li class="nav-item">
            <a href="{{ url_for('settings') }}" class="nav-link"><span class="nav-icon">⚙️</span><span class="nav-text">Settings</span></a>
          </li>
        </ul>
      </nav>
      <div class="sidebar-footer">
        <div class="user-profile">
          <div class="user-avatar" id="profileAvatar">A</div>
          <div class="user-info">
            <div class="user-name" id="profileName">Admin</div>
            <div class="user-role"><span id="profileEmail">admin@company.com</span></div>
          </div>
        </div>
      </div>
    </aside>

    <!-- Main -->
    <main class="dashboard-main">
      <header class="dashboard-header">
        <div class="header-left">
          <button class="sidebar-toggle" id="sidebarToggle"><span></span><span></span><span></span></button>
          <h1>Shipments</h1>
        </div>
        <div class="header-right">
          <div class="datetime-display">
            <span id="current-date"></span>
            <span id="current-time"></span>
            <span id="current-day"></span>
          </div>
          <div class="header-actions">
            <div class="notification-dropdown">
              <button class="notification-btn" id="notificationBtn">🔔<span class="notification-badge" id="notificationBadge" style="display:none;">0</span></button>
              <div class="notification-menu" id="notificationMenu">
                <div class="notification-header">
                  <h3>Notifications</h3>
                  <button class="mark-all-read-btn" id="markAllReadBtn">Mark all as read</button>
                </div>
                <div class="notification-list" id="notificationList">
                  <div class="loading-notifications">Loading notifications...</div>
                </div>
                <div class="notification-footer">
                  <button class="view-all-btn" id="viewAllNotificationsBtn">View All Notifications</button>
                </div>
              </div>
            </div>
            <div class="profile-dropdown">
              <button class="profile-btn" id="profileBtn">👤</button>
              <div class="profile-menu" id="profileMenu">
                <div class="profile-header">
                  <div class="profile-avatar-large" id="profileAvatarMenu">A</div>
                  <div class="profile-info">
                    <h3 id="profileNameMenu">Administrator</h3>
                    <p id="profileEmailMenu">admin@company.com</p>
                  </div>
                </div>
                <div class="profile-actions">
                  <a class="btn" href="{{ url_for('admin_profile') }}">Edit Profile</a>
                </div>
              </div>
            </div>
          </div>
        </div>
      </header>

      <div class="dashboard-content">
        <!-- Filters -->
        <div class="users-header" style="margin-bottom:12px;">
          <div class="users-stats">
            <div class="stat-item">
              <div class="stat-icon">📦</div>
              <span class="stat-number">{{ shipments.total }}</span>
              <span class="stat-label">Total Shipments</span>
            </div>
            <div class="stat-item">
              <div class="stat-icon">📅</div>
              <span class="stat-number">{{ shipments.items|length }}</span>
              <span class="stat-label">Showing</span>
            </div>
          </div>
          <div class="users-actions">
            <form method="GET" class="search-form">
              <div class="search-container">
                <input type="text" name="search" placeholder="Search AWB, sender, receiver, origin, destination..." value="{{ search }}" class="search-input">
                <button type="submit" class="btn btn-primary">Search</button>
              </div>
            </form>
            <form method="GET" class="per-page-form" style="display:flex; align-items:center; gap:8px;">
              <input type="hidden" name="search" value="{{ search }}"/>
              <label for="status" style="color:#94a3b8; font-size:13px;">Status:</label>
              <select name="status" id="status" onchange="this.form.submit()" style="height:40px; background:#0f172a; color:#e5e7eb; border:1px solid #334155; border-radius:10px; padding:0 10px;">
                <option value="">All</option>
                {% for s in statuses %}
                  <option value="{{ s }}" {% if status==s %}selected{% endif %}>{{ s }}</option>
                {% endfor %}
              </select>
              <label for="per_page" style="color:#94a3b8; font-size:13px;">Show:</label>
              <select name="per_page" id="per_page" onchange="this.form.submit()" style="height:40px; background:#0f172a; color:#e5e7eb; border:1px solid #334155; border-radius:10px; padding:0 10px;">
                <option value="5" {% if request.args.get('per_page')=='5' %}selected{% endif %}>5</option>
                <option value="25" {% if request.args.get('per_page')=='25' %}selected{% endif %}>25</option>
                <option value="50" {% if request.args.get('per_page')=='50' %}selected{% endif %}>50</option>
                <option value="100" {% if request.args.get('per_page')=='100' %}selected{% endif %}>100</option>
                <option value="all" {% if request.args.get('per_page')=='all' %}selected{% endif %}>All</option>
              </select>
            </form>
          </div>
        </div>

        <!-- Table -->
        <div class="users-table-container">
          <table class="users-table">
            <thead>
              <tr>
                <th>AWB</th>
                <th>Sender</th>
                <th>Receiver</th>
                <th>Route</th>
                <th>Weight (kg)</th>
                <th>Price</th>
                <th>Status</th>
                <th>Created</th>
              </tr>
            </thead>
            <tbody>
              {% for s in shipments.items %}
              <tr>
                <td class="customer-info"><div class="customer-name">{{ s.awb }}</div></td>
                <td class="contact-info">
                  <div class="contact-email">{{ s.sender_name }}</div>
                  <div class="contact-phone">{{ s.sender_phone or '' }}</div>
                </td>
                <td class="contact-info">
                  <div class="contact-email">{{ s.receiver_name }}</div>
                  <div class="contact-phone">{{ s.receiver_phone or '' }}</div>
                </td>
                <td class="location-info">
                  <div class="location-full">{{ s.origin }} → {{ s.destination }}</div>
                </td>
                <td class="date-info"><div class="date-primary">{{ '%.2f'|format(s.weight_kg or 0) }}</div></td>
                <td class="date-info"><div class="date-primary">{{ (s.price or 0)|lkr }}</div></td>
                <td class="status-info">
                  <span class="status-badge {% if s.status in ['Delivered'] %}active{% else %}inactive{% endif %}">{{ s.status }}</span>
                </td>
                <td class="date-info">
                  <div class="date-primary">{{ s.created_at.strftime('%d %b %Y') if s.created_at else '' }}</div>
                  <div class="date-secondary">{{ s.created_at.strftime('%H:%M') if s.created_at else '' }}</div>
                </td>
              </tr>
              {% else %}
              <tr>
                <td colspan="8" class="no-data">
                  {% if search or status %}
                    No shipments found for the given filters.
                  {% else %}
                    No shipments yet.
                  {% endif %}
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>

        <!-- Pagination -->
        {% if shipments.pages > 1 %}
        <div class="pagination-container">
          <div class="pagination">
            {% if shipments.has_prev %}
              <a class="page-btn" href="{{ url_for('shipments', page=shipments.prev_num, search=search, status=status, per_page=request.args.get('per_page', 10)) }}">← Previous</a>
            {% endif %}
            {% for page_num in shipments.iter_pages() %}
              {% if page_num %}
                {% if page_num != shipments.page %}
                  <a class="page-btn" href="{{ url_for('shipments', page=page_num, search=search, status=status, per_page=request.args.get('per_page', 10)) }}">{{ page_num }}</a>
                {% else %}
                  <span class="page-btn active">{{ page_num }}</span>
                {% endif %}
              {% else %}
                <span class="page-btn disabled">...</span>
              {% endif %}
            {% endfor %}
            {% if shipments.has_next %}
              <a class="page-btn" href="{{ url_for('shipments', page=shipments.next_num, search=search, status=status, per_page=request.args.get('per_page', 10)) }}">Next →</a>
            {% endif %}
          </div>
          <div class="pagination-info">
            Showing {{ shipments.per_page * (shipments.page - 1) + 1 }} to
            {{ shipments.per_page * (shipments.page - 1) + shipments.items|length }} of
            {{ shipments.total }} shipments
          </div>
        </div>
        {% endif %}
      </div>
    </main>
  </div>

  <script>
  // minimal header/profile/date init like other admin pages
  function toggleSidebar(){ 
    const s=document.querySelector('.dashboard-sidebar'); 
    const m=document.querySelector('.dashboard-main'); 
    s.classList.toggle('collapsed'); 
    m.classList.toggle('expanded'); 
  }
  // Update date, time, and day in header
  function updateDateTime(){
    try{
      const now = new Date();
      const dateOptions = { year:'numeric', month:'long', day:'numeric' };
      const timeOptions = { hour:'2-digit', minute:'2-digit', second:'2-digit', hour12:true };
      const dayOptions  = { weekday:'long' };
      const elDate = document.getElementById('current-date');
      const elTime = document.getElementById('current-time');
      const elDay  = document.getElementById('current-day');
      if (elDate) elDate.textContent = now.toLocaleDateString('en-US', dateOptions);
      if (elTime) elTime.textContent = now.toLocaleTimeString('en-US', timeOptions);
      if (elDay)  elDay.textContent  = now.toLocaleDateString('en-US', dayOptions);
    }catch(e){ /* noop */ }
  }
  document.addEventListener('DOMContentLoaded', ()=>{
    const btn=document.getElementById('sidebarToggle'); 
    if(btn) btn.addEventListener('click', toggleSidebar);

    // Date/time
    try{ updateDateTime(); setInterval(updateDateTime, 1000); }catch(e){}

    // Load admin profile into sidebar and dropdown
    (async function loadAdminProfile(){
      try{
        const res = await fetch('/api/admin/profile');
        const data = await res.json();
        if (data && (data.name !== undefined)){
          const name = (data.name || '').trim() || 'Admin';
          const email = data.email || '';
          const avatarChar = name ? name[0].toUpperCase() : 'A';
          const nameEl = document.getElementById('profileName');
          const emailEl = document.getElementById('profileEmail');
          const avatarEl = document.getElementById('profileAvatar');
          if (nameEl) nameEl.textContent = name;
          if (emailEl) emailEl.textContent = email;
          if (avatarEl) avatarEl.textContent = avatarChar;
          // Dropdown menu elements
          const nameMenu = document.getElementById('profileNameMenu');
          const emailMenu = document.getElementById('profileEmailMenu');
          const avatarMenu = document.getElementById('profileAvatarMenu');
          if (nameMenu) nameMenu.textContent = name;
          if (emailMenu) emailMenu.textContent = email;
          if (avatarMenu) avatarMenu.textContent = avatarChar;
        }
      }catch(e){ /* best-effort */ }
    })();

    // Notifications
    const notificationBtn = document.getElementById('notificationBtn');
    const notificationMenu = document.getElementById('notificationMenu');
    const markAllReadBtn = document.getElementById('markAllReadBtn');
    const viewAllBtn = document.getElementById('viewAllNotificationsBtn');
    function updateNotificationBadge(count){
      const badge = document.getElementById('notificationBadge');
      if (!badge) return;
      if (count > 0) { badge.textContent = count > 99 ? '99+' : count; badge.style.display='block'; }
      else { badge.style.display='none'; }
    }
    async function loadNotifications(){
      try{
        const res = await fetch('/api/notifications');
        const data = await res.json();
        updateNotificationBadge(data.unread_count||0);
        const list = document.getElementById('notificationList');
        const items = data.notifications||[];
        if (!items.length){ list.innerHTML = '<div class="no-notifications">No notifications</div>'; return; }
        list.innerHTML = items.map(n=>`<div class="notification-item ${n.is_read?'read':'unread'}"><div class="notification-icon">${n.type==='booking'?'📦':(n.type==='shipment'?'🚚':(n.type==='message'?'💬':'🔔'))}</div><div class="notification-content"><div class="notification-title">${n.title}</div><div class="notification-message">${n.message}</div><div class="notification-time">${n.created_at_human||''}</div></div></div>`).join('');
      }catch(e){ console.warn('notifications load failed', e); }
    }
    if (notificationBtn && notificationMenu){
      notificationBtn.addEventListener('click', async (e)=>{
        e.stopPropagation();
        const visible = notificationMenu.classList.contains('show');
        if (!visible) await loadNotifications();
        notificationMenu.classList.toggle('show');
      });
    }
    if (markAllReadBtn){
      markAllReadBtn.addEventListener('click', async (e)=>{
        e.stopPropagation();
        try{ await fetch('/api/notifications/mark-all-read', { method:'POST' }); loadNotifications(); }catch{}
      });
    }
    if (viewAllBtn){
      viewAllBtn.addEventListener('click', ()=> window.location.href='/notifications');
    }

    // Profile dropdown toggle
    const profileBtn = document.getElementById('profileBtn');
    const profileMenu = document.getElementById('profileMenu');
    if (profileBtn && profileMenu){
      profileBtn.addEventListener('click', (e)=>{
        e.stopPropagation();
        profileMenu.classList.toggle('show');
      });
    }

    // Close menus when clicking outside
    document.addEventListener('click', (e)=>{
      const profileDropdown = document.querySelector('.profile-dropdown');
      const notificationDropdown = document.querySelector('.notification-dropdown');
      if (profileDropdown && !profileDropdown.contains(e.target)){
        const m=document.getElementById('profileMenu'); if (m) m.classList.remove('show');
      }
      if (notificationDropdown && !notificationDropdown.contains(e.target)){
        const m=document.getElementById('notificationMenu'); if (m) m.classList.remove('show');
      }
    });

    // Active nav on load
    try{
      const currentPath=window.location.pathname;
      const links=document.querySelectorAll('.sidebar-nav .nav-link');
      let matched = false;
      links.forEach(link=>{
        const a=document.createElement('a'); a.href=link.getAttribute('href');
        if(a.pathname===currentPath){
          document.querySelectorAll('.sidebar-nav .nav-item').forEach(i=>i.classList.remove('active'));
          link.parentElement.classList.add('active');
          matched = true;
        }
      });
      if (!matched) {
        // Fallback: explicitly set Shipments active by href
        const shipmentsLink = document.querySelector(`.sidebar-nav .nav-link[href="{{ url_for('shipments') }}"]`);
        if (shipmentsLink) {
          document.querySelectorAll('.sidebar-nav .nav-item').forEach(i=>i.classList.remove('active'));
          shipmentsLink.parentElement.classList.add('active');
        }
      }
    }catch(e){}
  });
  </script>
</body>
</html>