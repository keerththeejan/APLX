<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Management - Admin Dashboard</title>
    <style>
    /* Loading state */
    .loading {
        display: flex;
        justify-content: center;
        align-items: center;
        height: 300px;
        font-size: 1.2rem;
        color: #666;
    }
    
    /* Section transitions */
    .dashboard-main {
        transition: opacity 0.3s ease;
    }
    
    .dashboard-main.loading {
        opacity: 0.7;
        pointer-events: none;
    }
    
    /* Active state for nav items */
    .nav-item.active .nav-link {
        background-color: rgba(255, 255, 255, 0.1);
        border-left: 3px solid #4CAF50;
    }
    
    .nav-item.active .nav-link .nav-icon {
        transform: scale(1.1);
    }
    </style>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
</head>
<body class="dashboard-body">
    <div class="dashboard-layout">
        <!-- Sidebar -->
        <aside class="dashboard-sidebar">
            <div class="sidebar-header">
                <div class="logo">
                    <span class="logo-icon">üöö</span>
                    <span class="logo-text">Admin Panel</span>
                </div>
            </div>
            
            <nav class="sidebar-nav">
                <ul class="nav-menu">
                    <li class="nav-item">
                        <a href="#" class="nav-link" data-section="dashboard">
                            <span class="nav-icon">üìä</span>
                            <span class="nav-text">Dashboard</span>
                        </a>
                    </li>
                    <li class="nav-item active">
                        <a href="#" class="nav-link" data-section="users">
                            <span class="nav-icon">üë•</span>
                            <span class="nav-text">Users</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="#" class="nav-link" data-section="shipments">
                            <span class="nav-icon">üì¶</span>
                            <span class="nav-text">Shipments</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="#" class="nav-link" data-section="books">
                            <span class="nav-icon">üìö</span>
                            <span class="nav-text">Books</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="#" class="nav-link" data-section="bookings">
                            <span class="nav-icon">üé´</span>
                            <span class="nav-text">Bookings</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="#" class="nav-link" data-section="revenue">
                            <span class="nav-icon">üí∞</span>
                            <span class="nav-text">Revenue</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="#" class="nav-link" data-section="analytics">
                            <span class="nav-icon">üìà</span>
                            <span class="nav-text">Analytics</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="#" class="nav-link" data-section="settings">
                            <span class="nav-icon">‚öôÔ∏è</span>
                            <span class="nav-text">Settings</span>
                        </a>
                    </li>
                </ul>
            </nav>
            
            <div class="sidebar-footer">
                <div class="user-profile">
                    <div class="user-avatar">A</div>
                    <div class="user-info">
                        <div class="user-name">Admin</div>
                        <div class="user-role">Administrator</div>
                    </div>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="dashboard-main">
            <!-- Top Header -->
            <header class="dashboard-header">
                <div class="header-left">
                    <button class="sidebar-toggle" id="sidebarToggle">
                        <span></span>
                        <span></span>
                        <span></span>
                    </button>
                    <h1>User Management</h1>
                </div>
                <div class="header-right">
                    <div class="datetime-display">
                        <span id="current-date"></span>
                        <span id="current-time"></span>
                        <span id="current-day"></span>
                    </div>
                    <div class="header-actions">
                        <div class="notification-dropdown">
                            <button class="notification-btn" id="notificationBtn">
                                üîî
                                <span class="notification-badge" id="notificationBadge" style="display: none;">0</span>
                            </button>
                            <div class="notification-menu" id="notificationMenu">
                                <div class="notification-header">
                                    <h3>Notifications</h3>
                                    <button class="mark-all-read-btn" id="markAllReadBtn">Mark all as read</button>
                                </div>
                                <div class="notification-list" id="notificationList">
                                    <div class="loading-notifications">Loading notifications...</div>
                                </div>
                                <div class="notification-footer">
                                    <button class="view-all-btn">View All Notifications</button>
                                </div>
                            </div>
                        </div>
                        <div class="profile-dropdown">
                            <button class="profile-btn" id="profileBtn">üë§</button>
                            <div class="profile-menu" id="profileMenu">
                                <div class="profile-header">
                                    <div class="profile-avatar-large">A</div>
                                    <div class="profile-info">
                                        <h3>Administrator</h3>
                                        <p>admin@company.com</p>
                                    </div>
                                </div>
                                <div class="profile-details">
                                    <div class="detail-item">
                                        <label>Name:</label>
                                        <div class="detail-value">
                                            <span id="adminName">Administrator</span>
                                            <button class="edit-btn" onclick="editField('name')">‚úèÔ∏è</button>
                                        </div>
                                        <input type="text" id="adminNameInput" class="edit-input" style="display: none;" value="Administrator">
                                    </div>
                                    <div class="detail-item">
                                        <label>Email:</label>
                                        <div class="detail-value">
                                            <span id="adminEmail">admin@company.com</span>
                                            <button class="edit-btn" onclick="editField('email')">‚úèÔ∏è</button>
                                        </div>
                                        <input type="email" id="adminEmailInput" class="edit-input" style="display: none;" value="admin@company.com">
                                    </div>
                                    <div class="detail-item">
                                        <label>Password:</label>
                                        <div class="detail-value">
                                            <span id="adminPassword">‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢</span>
                                            <div class="password-actions">
                                                <button class="toggle-password-btn" onclick="togglePasswordVisibility()" title="Show/Hide Password">üëÅÔ∏è</button>
                                                <button class="edit-btn" onclick="editField('password')">‚úèÔ∏è</button>
                                            </div>
                                        </div>
                                        <div class="password-input-container" style="display: none;">
                                            <input type="password" id="adminPasswordInput" class="edit-input" value="admin123">
                                            <button class="toggle-input-password-btn" onclick="toggleInputPasswordVisibility()" title="Show/Hide Password">üëÅÔ∏è</button>
                                        </div>
                                    </div>
                                </div>
                                <div class="profile-actions">
                                    <button class="save-btn" id="saveBtn" onclick="saveChanges()" style="display: none;">Save Changes</button>
                                    <button class="cancel-btn" id="cancelBtn" onclick="cancelEdit()" style="display: none;">Cancel</button>
                                    <button class="logout-btn" onclick="logout()">üö™ Logout</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </header>

            <!-- Users Content -->
            <div class="dashboard-content">
                <!-- Search and Actions -->
                <div class="users-header">
                    <div class="users-stats">
                        <div class="stat-item">
                            <span class="stat-number">{{ customers.total }}</span>
                            <span class="stat-label">Total Customers</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-number">{{ customers.items|length }}</span>
                            <span class="stat-label">Showing</span>
                        </div>
                    </div>
                    
                    <div class="users-actions">
                        <form method="GET" class="search-form">
                            <div class="search-container">
                                <input type="text" name="search" placeholder="Search customers..." value="{{ search }}" class="search-input">
                                <button type="submit" class="search-btn">üîç</button>
                            </div>
                        </form>
                        <button class="add-user-btn">+ Add Customer</button>
                    </div>
                </div>

                <!-- Users Table -->
                <div class="users-table-container">
                    <table class="users-table">
                        <thead>
                            <tr>
                                <th>Customer</th>
                                <th>Contact</th>
                                <th>Location</th>
                                <th>Registered</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for customer in customers.items %}
                            <tr class="user-row" data-customer-id="{{ customer.id }}">
                                <td class="customer-info">
                                    <div class="customer-avatar">{{ customer.first_name[0] }}{{ customer.last_name[0] }}</div>
                                    <div class="customer-details">
                                        <div class="customer-name">{{ customer.full_name }}</div>
                                        <div class="customer-id">#{{ customer.id }}</div>
                                    </div>
                                </td>
                                <td class="contact-info">
                                    <div class="contact-email">{{ customer.email }}</div>
                                    <div class="contact-phone">{{ customer.phone or 'No phone' }}</div>
                                </td>
                                <td class="location-info">
                                    <div class="location-city">{{ customer.city or 'Unknown' }}</div>
                                    <div class="location-country">{{ customer.country or 'Unknown' }}</div>
                                </td>
                                <td class="date-info">
                                    <div class="date-primary">{{ customer.created_at.strftime('%d %b %Y') }}</div>
                                    <div class="date-secondary">{{ customer.created_at.strftime('%H:%M') }}</div>
                                </td>
                                <td class="status-info">
                                    <span class="status-badge {{ 'active' if customer.is_active else 'inactive' }}">
                                        {{ 'Active' if customer.is_active else 'Inactive' }}
                                    </span>
                                </td>
                                <td class="actions-info" data-customer-id="{{ customer.id }}">
                                    <button class="action-btn view-btn" data-action="view" title="View Details">üëÅÔ∏è</button>
                                    <button class="action-btn edit-btn" data-action="edit" title="Edit Customer">‚úèÔ∏è</button>
                                    <button class="action-btn delete-btn" data-action="delete" title="Delete Customer">üóëÔ∏è</button>
                                </td>
                            </tr>
                            {% else %}
                            <tr>
                                <td colspan="6" class="no-data">
                                    {% if search %}
                                        No customers found matching "{{ search }}"
                                    {% else %}
                                        No customers registered yet
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>

                <!-- Pagination -->
                {% if customers.pages > 1 %}
                <div class="pagination-container">
                    <div class="pagination">
                        {% if customers.has_prev %}
                            <a href="{{ url_for('users', page=customers.prev_num, search=search) }}" class="page-btn">‚Üê Previous</a>
                        {% endif %}
                        
                        {% for page_num in customers.iter_pages() %}
                            {% if page_num %}
                                {% if page_num != customers.page %}
                                    <a href="{{ url_for('users', page=page_num, search=search) }}" class="page-btn">{{ page_num }}</a>
                                {% else %}
                                    <span class="page-btn active">{{ page_num }}</span>
                                {% endif %}
                            {% else %}
                                <span class="page-btn disabled">...</span>
                            {% endif %}
                        {% endfor %}
                        
                        {% if customers.has_next %}
                            <a href="{{ url_for('users', page=customers.next_num, search=search) }}" class="page-btn">Next ‚Üí</a>
                        {% endif %}
                    </div>
                    
                    <div class="pagination-info">
                        Showing {{ customers.per_page * (customers.page - 1) + 1 }} to 
                        {{ customers.per_page * (customers.page - 1) + customers.items|length }} of 
                        {{ customers.total }} customers
                    </div>
                </div>
                {% endif %}
            </div>
        </main>
    </div>

    <!-- Customer Details Modal -->
    <div class="modal" id="customerModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Customer Details</h3>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body" id="customerModalBody">
                <div class="loading">Loading customer details...</div>
            </div>
        </div>
    </div>

<script>
// Include all the dashboard JavaScript functions from dashboard.html
// Function to update date, time, and day
function updateDateTime() {
    const now = new Date();
    
    // Format date
    const dateOptions = { 
        year: 'numeric', 
        month: 'long', 
        day: 'numeric' 
    };
    const formattedDate = now.toLocaleDateString('en-US', dateOptions);
    
    // Format time
    const timeOptions = { 
        hour: '2-digit', 
        minute: '2-digit', 
        second: '2-digit',
        hour12: true 
    };
    const formattedTime = now.toLocaleTimeString('en-US', timeOptions);
    
    // Format day
    const dayOptions = { weekday: 'long' };
    const formattedDay = now.toLocaleDateString('en-US', dayOptions);
    
    // Update the display
    document.getElementById('current-date').textContent = formattedDate;
    document.getElementById('current-time').textContent = formattedTime;
    document.getElementById('current-day').textContent = formattedDay;
}

// Sidebar toggle functionality
function toggleSidebar() {
    const sidebar = document.querySelector('.dashboard-sidebar');
    const main = document.querySelector('.dashboard-main');
    
    sidebar.classList.toggle('collapsed');
    main.classList.toggle('expanded');
}

// Customer management functions
function viewCustomer(customerId) {
    const modal = document.getElementById('customerModal');
    const modalBody = document.getElementById('customerModalBody');
    
    modal.style.display = 'block';
    modalBody.innerHTML = '<div class="loading">Loading customer details...</div>';
    
    fetch(`/api/customers/${customerId}`)
        .then(response => response.json())
        .then(customer => {
            modalBody.innerHTML = `
                <div class="customer-detail-card">
                    <div class="customer-header">
                        <div class="customer-avatar-large">${customer.first_name[0]}${customer.last_name[0]}</div>
                        <div class="customer-info">
                            <h3>${customer.full_name}</h3>
                            <p>Customer ID: #${customer.id}</p>
                            <span class="status-badge ${customer.is_active ? 'active' : 'inactive'}" id="customerStatusBadge">
                                ${customer.is_active ? 'Active' : 'Inactive'}
                            </span>
                        </div>
                    </div>
                    
                    <div class="customer-details-grid">
                        <div class="detail-section">
                            <h4>Contact Information</h4>
                            <div class="detail-row">
                                <span class="detail-label">Email:</span>
                                <span class="detail-value">${customer.email}</span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">Phone:</span>
                                <span class="detail-value">${customer.phone || 'Not provided'}</span>
                            </div>
                        </div>
                        
                        <div class="detail-section">
                            <h4>Address Information</h4>
                            <div class="detail-row">
                                <span class="detail-label">Address:</span>
                                <span class="detail-value">${customer.full_address || 'Not provided'}</span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">City:</span>
                                <span class="detail-value">${customer.city || 'Not provided'}</span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">State:</span>
                                <span class="detail-value">${customer.state || 'Not provided'}</span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">Country:</span>
                                <span class="detail-value">${customer.country || 'Not provided'}</span>
                            </div>
                        </div>
                        
                        <div class="detail-section">
                            <h4>Account Information</h4>
                            <div class="detail-row">
                                <span class="detail-label">Registered:</span>
                                <span class="detail-value">${customer.created_date} at ${customer.created_time}</span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">Status:</span>
                                <span class="detail-value">${customer.is_active ? 'Active' : 'Inactive'}</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="customer-actions" id="customerActions">
                        ${!customer.is_active ? `
                            <button class="btn btn-primary" onclick="approveCustomer(${customer.id}, this)" id="approveBtn">
                                Approve Customer
                            </button>
                        ` : ''}
                        <button class="btn btn-secondary" onclick="editCustomer(${customer.id})">
                            Edit Profile
                        </button>
                    </div>
                </div>
            `;
            
            // Update the customer details in the sidebar
            updateCustomerInSidebar(customer);
        })
        .catch(error => {
            modalBody.innerHTML = '<div class="error">Failed to load customer details. Please try again.</div>';
            console.error('Error loading customer details:', error);
        });
}

function approveCustomer(customerId, button) {
    if (!confirm('Are you sure you want to approve this customer?')) {
        return;
    }
    
    // Disable the button and show loading state
    button.disabled = true;
    button.innerHTML = '<span class="spinner">‚è≥</span> Approving...';
    
    fetch(`/api/customers/${customerId}/approve`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Show success message
            showFlashMessage(data.message || 'Customer approved successfully', 'success');
            
            // Update the UI
            const statusBadge = document.getElementById('customerStatusBadge');
            const customerActions = document.getElementById('customerActions');
            
            if (statusBadge) {
                statusBadge.textContent = 'Active';
                statusBadge.className = 'status-badge active';
            }
            
            if (button) {
                button.remove();
            }
            
            // Update the customer row in the table
            const customerRow = document.querySelector(`tr[data-customer-id="${customerId}"]`);
            if (customerRow) {
                const statusCell = customerRow.querySelector('.status-badge');
                if (statusCell) {
                    statusCell.textContent = 'Active';
                    statusCell.className = 'status-badge active';
                }
            }
            
            // Reload notifications to show the new approval notification
            loadNotifications();
        } else {
            throw new Error(data.error || 'Failed to approve customer');
        }
    })
    .catch(error => {
        console.error('Error approving customer:', error);
        showFlashMessage(error.message || 'Failed to approve customer. Please try again.', 'error');
        if (button) {
            button.disabled = false;
            button.innerHTML = 'Approve Customer';
        }
    });
}

function updateCustomerInSidebar(customer) {
    const sidebar = document.querySelector('.dashboard-sidebar');
    let customerDetails = sidebar.querySelector('.customer-details-sidebar');
    
    if (!customerDetails) {
        customerDetails = document.createElement('div');
        customerDetails.className = 'customer-details-sidebar';
        const navMenu = sidebar.querySelector('.nav-menu');
        if (navMenu) {
            sidebar.insertBefore(customerDetails, navMenu.nextSibling);
        } else {
            sidebar.appendChild(customerDetails);
        }
    }
    
    customerDetails.innerHTML = `
        <div class="sidebar-section">
            <h3>Customer Details</h3>
            <div class="sidebar-customer-info">
                <div class="sidebar-avatar">${customer.first_name[0]}${customer.last_name[0]}</div>
                <div class="sidebar-customer-name">${customer.full_name}</div>
                <div class="sidebar-customer-email">${customer.email}</div>
                <div class="sidebar-customer-meta">
                    <span class="status-badge ${customer.is_active ? 'active' : 'inactive'}">
                        ${customer.is_active ? 'Active' : 'Inactive'}
                    </span>
                    <span class="customer-id">#${customer.id}</span>
                </div>
            </div>
            <div class="sidebar-customer-details">
                <div class="detail-row">
                    <span class="detail-label">Phone:</span>
                    <span class="detail-value">${customer.phone || 'N/A'}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Location:</span>
                    <span class="detail-value">
                        ${[customer.city, customer.state, customer.country].filter(Boolean).join(', ') || 'N/A'}
                    </span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Member since:</span>
                    <span class="detail-value">${customer.created_date}</span>
                </div>
            </div>
        </div>
    `;
}

function showFlashMessage(message, type = 'success') {
    // Create flash message element
    const flashMessage = document.createElement('div');
    flashMessage.className = `flash-message ${type}`;
    flashMessage.textContent = message;
    
    // Add to the page
    const header = document.querySelector('.dashboard-header');
    if (header) {
        header.insertAdjacentElement('afterend', flashMessage);
    } else {
        document.body.insertAdjacentElement('afterbegin', flashMessage);
    }
    
    // Auto-remove after 5 seconds
    setTimeout(() => {
        flashMessage.classList.add('fade-out');
        setTimeout(() => flashMessage.remove(), 500);
    }, 5000);
}

function editCustomer(customerId) {
    alert(`Edit customer functionality will be implemented for customer ID: ${customerId}`);
}

function deleteCustomer(customerId) {
    if (confirm('Are you sure you want to delete this customer?')) {
        alert(`Delete customer functionality will be implemented for customer ID: ${customerId}`);
    }
}

function closeModal() {
    document.getElementById('customerModal').style.display = 'none';
}

// Notification functions (simplified version)
function loadNotifications() {
    fetch('/api/notifications')
        .then(response => response.json())
        .then(data => {
            updateNotificationBadge(data.unread_count);
        })
        .catch(error => console.error('Error loading notifications:', error));
}

function updateNotificationBadge(count) {
    const badge = document.getElementById('notificationBadge');
    if (count > 0) {
        badge.textContent = count > 99 ? '99+' : count;
        badge.style.display = 'block';
    } else {
        badge.style.display = 'none';
    }
}

// Format an ISO date string to local time label
function formatLocalTime(isoString) {
    try {
        if (!isoString) return '';
        const d = new Date(isoString);
        return d.toLocaleString(undefined, {
            year: 'numeric', month: 'short', day: '2-digit',
            hour: '2-digit', minute: '2-digit'
        });
    } catch (e) {
        return '';
    }
}

// Build notification list UI inside the dropdown
function renderNotificationList(notifications) {
    const list = document.getElementById('notificationList');
    if (!list) return;

    if (!notifications || notifications.length === 0) {
        list.innerHTML = '<div class="no-notifications">No notifications</div>';
        return;
    }

    const itemHtml = notifications.map(n => {
        const icon = n.type === 'booking' ? 'üì¶' : (n.type === 'shipment' ? 'üöö' : 'üí¨');
        const unreadClass = n.is_read ? '' : ' unread';
        const time = n.created_at_human || n.created_at;
        const timeTitle = n.created_at_iso ? formatLocalTime(n.created_at_iso) : '';
        return `
            <div class="notification-item${unreadClass}" data-id="${n.id}">
                <div class="notification-icon">${icon}</div>
                <div class="notification-text">
                    <div class="notification-title">${n.title}</div>
                    <div class="notification-message">${n.message}</div>
                    <div class="notification-time" title="${timeTitle}">${time}</div>
                </div>
            </div>
        `;
    }).join('');

    list.innerHTML = itemHtml;
}

// Fetch notifications and populate dropdown list
function loadNotificationsList() {
    const list = document.getElementById('notificationList');
    if (list) list.innerHTML = '<div class="loading-notifications">Loading notifications...</div>';
    return fetch('/api/notifications?only=unread&limit=5&max_age_hours=24')
        .then(r => r.json())
        .then(data => {
            updateNotificationBadge(data.unread_count || 0);
            renderNotificationList(data.notifications || []);
        })
        .catch(err => {
            console.error('Error loading notifications:', err);
            if (list) list.innerHTML = '<div class="error">Failed to load notifications</div>';
        });
}

// Function to load section content
async function loadSection(section) {
    try {
        // Show loading state
        const mainContent = document.querySelector('.dashboard-main');
        mainContent.innerHTML = '<div class="loading">Loading...</div>';
        
        // Remove active class from all nav items
        document.querySelectorAll('.nav-item').forEach(item => {
            item.classList.remove('active');
        });
        
        // Add active class to current nav item
        const activeNavItem = document.querySelector(`.nav-link[data-section="${section}"]`).parentElement;
        if (activeNavItem) {
            activeNavItem.classList.add('active');
        }
        
        // Store current section in URL
        window.history.pushState({ section }, '', `/${section}`);
        
        // Load section content
        const response = await fetch(`/section/${section}`);
        if (!response.ok) throw new Error('Failed to load section');
        
        const html = await response.text();
        mainContent.innerHTML = html;
        
    } catch (error) {
        console.error('Error loading section:', error);
        showFlashMessage('Failed to load section. Please try again.', 'error');
    }
}

// Handle browser back/forward buttons
window.addEventListener('popstate', (event) => {
    if (event.state && event.state.section) {
        loadSection(event.state.section);
    }
});

// Event delegation for sidebar navigation
document.querySelector('.sidebar-nav').addEventListener('click', (e) => {
    const navLink = e.target.closest('.nav-link');
    if (!navLink) return;
    
    e.preventDefault();
    const section = navLink.dataset.section;
    if (section) {
        loadSection(section);
    }
});

// Event delegation for action buttons
document.addEventListener('click', function(event) {
    const button = event.target.closest('.action-btn');
    if (!button) return;
    
    const actionsCell = button.closest('.actions-info');
    if (!actionsCell) return;
    
    const customerId = actionsCell.dataset.customerId;
    if (!customerId) return;
    
    const action = button.dataset.action;
    
    switch(action) {
        case 'view':
            viewCustomer(parseInt(customerId, 10));
            break;
        case 'edit':
            editCustomer(parseInt(customerId, 10));
            break;
        case 'delete':
            deleteCustomer(parseInt(customerId, 10));
            break;
    }
});

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    // Update date/time immediately and then every second
    updateDateTime();
    setInterval(updateDateTime, 1000);
    
    // Load notifications
    loadNotifications();
    setInterval(loadNotifications, 30000);
    
    // Sidebar toggle
    const sidebarToggle = document.getElementById('sidebarToggle');
    if (sidebarToggle) {
        sidebarToggle.addEventListener('click', toggleSidebar);
    }
    
    // Close modal when clicking outside
    window.addEventListener('click', function(event) {
        const modal = document.getElementById('customerModal');
        if (event.target === modal) {
            closeModal();
        }

        // Close notification dropdown when clicking outside
        const menu = document.getElementById('notificationMenu');
        const btn = document.getElementById('notificationBtn');
        if (menu && btn && !menu.contains(event.target) && !btn.contains(event.target)) {
            menu.style.display = 'none';
        }
    });

    // Notification dropdown toggle and actions
    const notificationBtn = document.getElementById('notificationBtn');
    const notificationMenu = document.getElementById('notificationMenu');
    const markAllReadBtn = document.getElementById('markAllReadBtn');
    const viewAllBtn = document.querySelector('.notification-footer .view-all-btn');

    if (notificationBtn && notificationMenu) {
        notificationBtn.addEventListener('click', async () => {
            const isVisible = notificationMenu.style.display === 'block';
            if (isVisible) {
                notificationMenu.style.display = 'none';
            } else {
                notificationMenu.style.display = 'block';
                await loadNotificationsList();
            }
        });
    }

    if (markAllReadBtn) {
        markAllReadBtn.addEventListener('click', async () => {
            try {
                // simple in-flight feedback
                const originalText = markAllReadBtn.textContent;
                markAllReadBtn.textContent = 'Marking...';
                markAllReadBtn.classList.add('disabled');
                markAllReadBtn.setAttribute('aria-busy', 'true');

                const res = await fetch('/api/notifications/mark-all-read', { method: 'POST' });
                const data = await res.json();
                if (data.success) {
                    // Clear the list and reset badge
                    renderNotificationList([]);
                    updateNotificationBadge(0);
                    // Close the dropdown to remove any visible details
                    if (notificationMenu) {
                        notificationMenu.style.display = 'none';
                    }
                }

                // restore button
                markAllReadBtn.textContent = originalText;
                markAllReadBtn.classList.remove('disabled');
                markAllReadBtn.removeAttribute('aria-busy');
            } catch (e) {
                console.error('Error marking all notifications as read:', e);
                // restore button
                markAllReadBtn.classList.remove('disabled');
                markAllReadBtn.removeAttribute('aria-busy');
            }
        });
    }

    if (viewAllBtn) {
        viewAllBtn.addEventListener('click', () => {
            window.location.href = '/notifications';
        });
    }
    
    // Load current section based on URL
    const path = window.location.pathname.split('/').filter(Boolean);
    const currentSection = path[0] || 'dashboard';
    loadSection(currentSection);
});
</script>
</body>
</html>
