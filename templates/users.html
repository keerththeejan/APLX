<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Management - Admin Dashboard</title>
    <style>
    /* Loading state */
    .loading {
        display: flex;
        justify-content: center;
        align-items: center;
        height: 300px;
        font-size: 1.2rem;
        color: #666;
    }

    /* Section transitions */
    .dashboard-main {
        transition: opacity 0.3s ease;
    }
    
    .dashboard-main.loading {
        opacity: 0.7;
        pointer-events: none;
    }
    
    /* Active state for nav items */
    .nav-item.active .nav-link {
        background-color: rgba(255, 255, 255, 0.1);
        border-left: 3px solid #4CAF50;
    }
    
    .nav-item.active .nav-link .nav-icon {
        transform: scale(1.1);
    }
    /* Add Customer modal: compact grid to fit without scrolling on desktop */
    .add-customer-form { margin-top: 2px; }
    .acf-section { margin: 6px 0 10px; }
    .acf-title { font-weight: 800; font-size: 14px; color: #e5e7eb; margin: 0 0 8px; padding-bottom: 6px; border-bottom: 1px solid #1f2937; }
    .acf-grid { display: grid; grid-template-columns: repeat(2, minmax(0, 1fr)); gap: 8px 10px; }
    .acf-field { display: grid; gap: 4px; }
    .acf-field label { color: #94a3b8; font-size: 12px; }
    .acf-field input, .acf-field select, .acf-field textarea { padding: 8px 10px; border-radius: 8px; border: 1px solid #334155; background:#0f172a; color:#e5e7eb; }
    .acf-col-span-2 { grid-column: 1 / -1; }
    .acf-actions { display:flex; justify-content:flex-end; gap:10px; padding-top: 8px; border-top: 1px solid #1f2937; margin-top: 6px; }
    @media (max-width: 720px) { .acf-grid { grid-template-columns: 1fr; } }
    @media (min-width: 1024px) {
      /* 3 columns on desktop to reduce height */
      .acf-grid { grid-template-columns: repeat(3, minmax(0, 1fr)); gap: 8px 10px; }
      /* prevent full-width spans on desktop so content fits */
      .acf-col-span-2 { grid-column: auto; }
      /* widen modal a bit and compact padding */
      .modal .modal-content { max-width: 1024px; }
      .modal .modal-body { padding: 12px; }
    }
    /* Full-width layout overrides for Users page */
    .users-page .dashboard-main { padding: 0 !important; }
    .users-page .dashboard-content { padding: 12px 12px !important; }
    .users-page .users-table-container { width: 100% !important; max-width: none !important; }
    .users-page .users-table { width: 100% !important; table-layout: fixed !important; }
    .users-page .users-header { padding-right: 8px !important; }
    .users-page .users-table { width: 100% !important; table-layout: fixed !important; }
    .users-page .users-header { padding-right: 8px !important; }
    .users-page .pagination-container { padding-right: 8px !important; }
    </style>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
</head>
<body class="dashboard-body users-page">
    <div class="dashboard-layout">
        <!-- Sidebar -->
        <aside class="dashboard-sidebar">
            <div class="sidebar-header">
                <div class="logo">
                    <span class="logo-icon">üöö</span>
                    <span class="logo-text">Admin Panel</span>
                </div>
            </div>
            <nav class="sidebar-nav">
                <ul class="nav-menu">
                    <li class="nav-item">
                        <a href="{{ url_for('dashboard') }}" class="nav-link">
                            <span class="nav-icon">üìä</span>
                            <span class="nav-text">Dashboard</span>
                        </a>
                    </li>
                    <li class="nav-item active">
                        <a href="{{ url_for('users') }}" class="nav-link">
                            <span class="nav-icon">üë•</span>
                            <span class="nav-text">Users</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="{{ url_for('shipments') }}" class="nav-link">
                            <span class="nav-icon">üì¶</span>
                            <span class="nav-text">Shipments</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="/admin/content" class="nav-link">
                            <span class="nav-icon">üß©</span>
                            <span class="nav-text">Content</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="{{ url_for('bookings') }}" class="nav-link">
                            <span class="nav-icon">üé´</span>
                            <span class="nav-text">Bookings</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="{{ url_for('analytics_page') }}" class="nav-link">
                            <span class="nav-icon">üìà</span>
                            <span class="nav-text">Analytics</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="{{ url_for('settings') }}" class="nav-link">
                            <span class="nav-icon">‚öôÔ∏è</span>
                            <span class="nav-text">Settings</span>
                        </a>
                    </li>
                </ul>
            </nav>
            <div class="sidebar-footer">
                <div class="user-profile">
                    <div class="user-avatar" id="profileAvatar">A</div>
                    <div class="user-info">
                        <div class="user-name" id="profileName">Admin</div>
                        <div class="user-role"><span id="profileEmail">Administrator</span></div>
                    </div>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="dashboard-main">
            <!-- Top Header -->
            <header class="dashboard-header">
                <div class="header-left">
                    <button class="sidebar-toggle" id="sidebarToggle">
                        <span></span>
                        <span></span>
                        <span></span>
                    </button>
                    <h1>Users</h1>
                </div>
                <div class="header-right">
                    <div class="datetime-display">
                        <span id="current-date"></span>
                        <span id="current-time"></span>
                        <span id="current-day"></span>
                    </div>
                    <div class="header-actions">
                        <div class="notification-dropdown">
                            <button class="notification-btn" id="notificationBtn">
                                üîî
                                <span class="notification-badge" id="notificationBadge" style="display: none;">0</span>
                            </button>
                            <div class="notification-menu" id="notificationMenu">
                                <div class="notification-header">
                                    <h3>Notifications</h3>
                                    <button class="mark-all-read-btn" id="markAllReadBtn">Mark all as read</button>
                                </div>
                                <div class="notification-list" id="notificationList">
                                    <div class="loading-notifications">Loading notifications...</div>
                                </div>
                                <div class="notification-footer">
                                    <button class="view-all-btn">View All Notifications</button>
                                </div>
                            </div>
                        </div>
                        <div class="profile-dropdown">
                            <button class="profile-btn" id="profileBtn">üë§</button>
                            <div class="profile-menu" id="profileMenu">
                                <div class="profile-header">
                                    <div class="profile-avatar-large" id="profileAvatar">A</div>
                                    <div class="profile-info">
                                        <h3 id="profileName">Administrator</h3>
                                        <p id="profileEmail">admin@company.com</p>
                                    </div>
                                </div>
                                <div class="profile-actions">
                                    <a class="btn" href="{{ url_for('admin_profile') }}">Edit Profile</a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </header>

            <!-- Users Content -->
            <div class="dashboard-content">
                <!-- Search and Actions -->
                <div class="users-header">
                    <div class="users-stats">
                        <div class="stat-item">
                            <div class="stat-icon">üë•</div>
                            <span class="stat-number">{{ customers.total }}</span>
                            <span class="stat-label">Total Customers</span>
                        </div>
                        <div class="stat-item">
                            <div class="stat-icon">üìÑ</div>
                            <span class="stat-number">{{ customers.items|length }}</span>
                            <span class="stat-label">Showing</span>
                        </div>
                    </div>
                    
                    <div class="users-actions">
                    <button type="button" class="btn btn-primary" id="openAddCustomerBtn" style="height:40px;" onclick="openAddCustomerModal()">+ Add Customer</button>
                    <form method="GET" class="search-form">
                        <div class="search-container">
                            <input type="text" name="search" placeholder="Search customers..." value="{{ search }}" class="search-input">
                            <button type="submit" class="btn btn-primary">Search</button>
                        </div>
                    </form>
                        <form method="GET" class="per-page-form" style="display:flex; align-items:center; gap:8px;">
                            <input type="hidden" name="search" value="{{ search }}" />
                            <label for="per_page" style="color:#94a3b8; font-size:13px;">Show:</label>
                            <select name="per_page" id="per_page" onchange="this.form.submit()" style="height:40px; background:#0f172a; color:#e5e7eb; border:1px solid #334155; border-radius:10px; padding:0 10px;">
                                <option value="5" {% if per_page=='5' %}selected{% endif %}>5</option>
                                <option value="25" {% if per_page=='25' %}selected{% endif %}>25</option>
                                <option value="50" {% if per_page=='50' %}selected{% endif %}>50</option>
                                <option value="100" {% if per_page=='100' %}selected{% endif %}>100</option>
                                <option value="all" {% if per_page=='all' %}selected{% endif %}>All</option>
                            </select>
                        </form>
                    </div>
                </div>

    <!-- Status Edit Modal -->
    <div class="modal" id="statusModal" style="display:none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Update Customer Status</h3>
                <button class="modal-close" onclick="closeStatusModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="statusForm">
                    <input type="hidden" id="status_id" />
                    <label style="display:flex; align-items:center; gap:8px;">
                        <input type="checkbox" id="status_is_active" />
                        <span>Active</span>
                    </label>
                </form>
            </div>
            <div class="modal-actions">
                <button type="button" class="btn btn-secondary" onclick="closeStatusModal()">Cancel</button>
                <button type="button" class="btn btn-primary" id="statusSaveBtn">Save</button>
            </div>
        </div>
    </div>

                <!-- Users Table -->
                <div class="users-table-container">
                    <table class="users-table">
                        <thead>
                            <tr>
                                <th>Customer</th>
                                <th>Contact</th>
                                <th>Address</th>
                                <th>Registered</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for customer in customers.items %}
                            <tr class="user-row" data-customer-id="{{ customer.id }}">
                                <td class="customer-info">
                                    <div class="customer-avatar">{{ customer.first_name[0] }}{{ customer.last_name[0] }}</div>
                                    <div class="customer-details">
                                        <div class="customer-name">{{ customer.full_name }}</div>
                                        <div class="customer-id">#{{ customer.id }}</div>
                                    </div>
                                </td>
                                <td class="contact-info">
                                    <div class="contact-email">{{ customer.email }}</div>
                                    <div class="contact-phone">{{ customer.phone or 'No phone' }}</div>
                                </td>
                                <td class="location-info">
                                    <div class="location-full">{{ customer.full_address or 'Not provided' }}</div>
                                </td>
                                <td class="date-info">
                                    <div class="date-primary">{{ customer.created_at.strftime('%d %b %Y') }}</div>
                                    <div class="date-secondary">{{ customer.created_at.strftime('%H:%M') }}</div>
                                </td>
                                <td class="status-info">
                                    <span class="status-badge {{ 'active' if customer.is_active else 'inactive' }}">
                                        {{ 'Active' if customer.is_active else 'Inactive' }}
                                    </span>
                                </td>
                                <td class="actions-info" data-customer-id="{{ customer.id }}">
                                    <button type="button" class="action-btn view-btn" data-action="view" title="View Details">üëÅÔ∏è</button>
                                    <button class="action-btn edit-btn" data-action="edit" title="Edit Customer">‚úèÔ∏è</button>
                                    <button class="action-btn delete-btn" data-action="delete" title="Delete Customer">üóëÔ∏è</button>
                                </td>
                            </tr>
                            {% else %}
                            <tr>
                                <td colspan="6" class="no-data">
                                    {% if search %}
                                        No customers found matching "{{ search }}"
                                    {% else %}
                                        No customers registered yet
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>

                <!-- Pagination -->
                {% if customers.pages > 1 %}
                <div class="pagination-container">
                    <div class="pagination">
                        {% if customers.has_prev %}
                            <a href="{{ url_for('users', page=customers.prev_num, search=search, per_page=per_page) }}" class="page-btn">‚Üê Previous</a>
                        {% endif %}
                        
                        {% for page_num in customers.iter_pages() %}
                            {% if page_num %}
                                {% if page_num != customers.page %}
                                    <a href="{{ url_for('users', page=page_num, search=search, per_page=per_page) }}" class="page-btn">{{ page_num }}</a>
                                {% else %}
                                    <span class="page-btn active">{{ page_num }}</span>
                                {% endif %}
                            {% else %}
                                <span class="page-btn disabled">...</span>
                            {% endif %}
                        {% endfor %}
                        
                        {% if customers.has_next %}
                            <a href="{{ url_for('users', page=customers.next_num, search=search, per_page=per_page) }}" class="page-btn">Next ‚Üí</a>
                        {% endif %}
                    </div>
                    
                    <div class="pagination-info">
                        Showing {{ customers.per_page * (customers.page - 1) + 1 }} to 
                        {{ customers.per_page * (customers.page - 1) + customers.items|length }} of 
                        {{ customers.total }} customers
                    </div>
                </div>
                {% endif %}
            </div>
        </main>

    </div>

    <!-- Customer Details Modal -->
    <div class="modal" id="customerModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Customer Details</h3>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body" id="customerModalBody">
                <div class="loading">Loading customer details...</div>
            </div>
        </div>
    </div>

    <!-- Add Customer Modal -->
    <div class="modal" id="addCustomerModal" style="display:none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Add New Customer</h3>
                <button class="modal-close" onclick="closeAddCustomerModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="addCustomerForm" class="add-customer-form" novalidate>
                  <div class="acf-section">
                    <div class="acf-title">Basic Information</div>
                    <div class="acf-grid">
                      <div class="acf-field">
                        <label>First Name *</label>
                        <input type="text" name="first_name" placeholder="e.g., John" required />
                      </div>
                      <div class="acf-field">
                        <label>Last Name *</label>
                        <input type="text" name="last_name" placeholder="e.g., Doe" required />
                      </div>
                      <div class="acf-field acf-col-span-2">
                        <label>Email *</label>
                        <input type="email" name="email" placeholder="name@example.com" required />
                      </div>
                    </div>
                  </div>

                  <div class="acf-section">
                    <div class="acf-title">Contact</div>
                    <div class="acf-grid">
                      <div class="acf-field acf-col-span-2">
                        <label>Phone</label>
                        <input type="text" name="phone" placeholder="+94 7X XXX XXXX" />
                      </div>
                    </div>
                  </div>

                  <div class="acf-section">
                    <div class="acf-title">Address</div>
                    <div class="acf-grid">
                      <div class="acf-field acf-col-span-2">
                        <label>Address</label>
                        <input type="text" name="address" placeholder="Street address" />
                      </div>
                      <div class="acf-field">
                        <label>City</label>
                        <input type="text" name="city" placeholder="City" />
                      </div>
                      <div class="acf-field">
                        <label>Province</label>
                        <input type="text" name="state" placeholder="Province/State" />
                      </div>
                      <div class="acf-field">
                        <label>Postal Code</label>
                        <input type="text" name="postal_code" placeholder="Postal code" />
                      </div>
                      <div class="acf-field">
                        <label>Country</label>
                        <input type="text" name="country" placeholder="Country" />
                      </div>
                    </div>
                  </div>

                  <div class="acf-section">
                    <div class="acf-title">Status</div>
                    <div class="acf-grid">
                      <div class="acf-field acf-col-span-2">
                        <label>Status</label>
                        <select name="is_active">
                          <option value="true" selected>Active</option>
                          <option value="false">Inactive</option>
                        </select>
                      </div>
                    </div>
                  </div>

                  <div class="acf-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeAddCustomerModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary" id="saveCustomerBtn">Save Customer</button>
                  </div>
                </form>
            </div>
        </div>
    </div>

<script>
// Lightweight client-side toast notifications
function ensureToastContainer() {
    let tc = document.querySelector('.toast-container');
    if (!tc) {
        tc = document.createElement('div');
        tc.className = 'toast-container';
        document.body.appendChild(tc);
    }
    return tc;
}

function showFlashMessage(message, type) {
    const tc = ensureToastContainer();
    const toast = document.createElement('div');
    toast.className = 'toast ' + (type === 'success' ? 'toast-success' : 'toast-error');
    toast.textContent = message || '';
    tc.appendChild(toast);
    // Auto-remove after ~3.2s
    setTimeout(() => {
        try { toast.remove(); } catch (e) { /* no-op */ }
    }, 3200);
}
// Include all the dashboard JavaScript functions from dashboard.html
// Function to update date, time, and day
function updateDateTime() {
    const now = new Date();
    
    // Format date
    const dateOptions = { 
        year: 'numeric', 
        month: 'long', 
        day: 'numeric' 
    };
    const formattedDate = now.toLocaleDateString('en-US', dateOptions);
    
    // Format time
    const timeOptions = { 
        hour: '2-digit', 
        minute: '2-digit', 
        second: '2-digit',
        hour12: true 
    };
    const formattedTime = now.toLocaleTimeString('en-US', timeOptions);
    
    // Format day
    const dayOptions = { weekday: 'long' };
    const formattedDay = now.toLocaleDateString('en-US', dayOptions);
    
    // Update the display
    document.getElementById('current-date').textContent = formattedDate;
    document.getElementById('current-time').textContent = formattedTime;
    document.getElementById('current-day').textContent = formattedDay;
}

// Sidebar toggle functionality
function toggleSidebar() {
    const sidebar = document.querySelector('.dashboard-sidebar');
    const main = document.querySelector('.dashboard-main');
    
    sidebar.classList.toggle('collapsed');
    main.classList.toggle('expanded');
}

// Show brief summary of a customer in the modal
function viewCustomer(customerId) {
    const modal = document.getElementById('customerModal');
    const modalBody = document.getElementById('customerModalBody');
    if (!modal || !modalBody) return;
    // Center the modal using global .modal.show flex behavior
    modal.classList.add('show');
    modal.style.display = 'flex';
    modalBody.innerHTML = '<div class="loading">Loading customer details...</div>';
    fetch(`/api/customers/${customerId}`)
        .then(r => r.json())
        .then(data => {
            // Support multiple API response shapes
            const c = (data && data.customer)
                ? data.customer
                : (data && data.success === false)
                    ? null
                    : data;
            if (!c) throw new Error((data && data.error) || 'Not found');
            const first = (c.first_name || '').trim();
            const last = (c.last_name || '').trim();
            const fullName = c.full_name || `${first} ${last}`.trim();
            const initials = `${first.charAt(0)}${last.charAt(0)}`.toUpperCase() || (fullName.charAt(0).toUpperCase() || 'C');
            const phone = c.phone || 'Not provided';
            const addr1 = c.address || '';
            const city = c.city || '';
            const state = c.state || '';
            const postal = c.postal_code || '';
            const country = c.country || '';
            const statusBadge = c.is_active ? '<span class="status-badge active">Active</span>' : '<span class="status-badge inactive">Inactive</span>';
            // Build a read-only grid similar to Add form
            modalBody.innerHTML = `
                <div class="customer-detail-card">
                  <div class="customer-header" style="display:flex; align-items:center; gap:12px; margin-bottom:12px;">
                    <div class="customer-avatar-large" style="width:48px;height:48px;border-radius:50%;background:#374151;color:#fff;display:flex;align-items:center;justify-content:center;font-weight:800;">${initials}</div>
                    <div style="flex:1; min-width:0;">
                      <h3 style="margin:0 0 6px; display:flex; align-items:center; gap:8px; flex-wrap:wrap;">${fullName} <small style="color:#94a3b8; font-weight:600;">#${c.id || ''}</small> ${statusBadge}</h3>
                    </div>
                  </div>
                  <div class="acf-grid" style="grid-template-columns: repeat(2, minmax(0, 1fr)); gap: 8px 10px;">
                    <div class="acf-field"><label>Email</label><input value="${c.email || ''}" readonly /></div>
                    <div class="acf-field"><label>Phone</label><input value="${phone}" readonly /></div>
                    <div class="acf-field acf-col-span-2"><label>Address</label><input value="${addr1}" readonly /></div>
                    <div class="acf-field"><label>City</label><input value="${city}" readonly /></div>
                    <div class="acf-field"><label>Province</label><input value="${state}" readonly /></div>
                    <div class="acf-field"><label>Postal Code</label><input value="${postal}" readonly /></div>
                    <div class="acf-field"><label>Country</label><input value="${country}" readonly /></div>
                  </div>
                </div>`;
        })
        .catch(err => {
            console.error('viewCustomer failed', err);
            modalBody.innerHTML = '<div class="error">Failed to load customer details</div>';
        });
}

function closeModal() {
    const modal = document.getElementById('customerModal');
    if (modal) { modal.classList.remove('show'); modal.style.display = 'none'; }
}

// Close Add Customer modal helper
function closeAddCustomerModal() {
    const addCustomerModal = document.getElementById('addCustomerModal');
    if (addCustomerModal) {
        addCustomerModal.classList.remove('show');
        addCustomerModal.style.display = 'none';
    }
}

// Open Add Customer modal helper (global)
function openAddCustomerModal() {
    try {
        const m = document.getElementById('addCustomerModal');
        if (m) {
            m.classList.add('show');
            m.style.display = 'flex';
        }
    } catch (e) { /* no-op */ }
}

// Close Status modal helper
function closeStatusModal() {
    const m = document.getElementById('statusModal');
    if (m) {
        m.classList.remove('show');
        m.style.display = 'none';
    }
}

// Load admin profile for navbar
async function loadAdminProfile() {
    try {
        const res = await fetch('/api/admin/profile');
        const data = await res.json();
        if (data && (data.name !== undefined)) {
            const name = (data.name || '').trim() || 'Admin';
            const email = data.email || '';
            const nameEl = document.getElementById('profileName');
            const emailEl = document.getElementById('profileEmail');
            const avatarEl = document.getElementById('profileAvatar');
            if (nameEl) nameEl.textContent = name;
            if (emailEl) emailEl.textContent = email;
            if (avatarEl) avatarEl.textContent = name ? name[0].toUpperCase() : 'A';
        }
    } catch (e) {
        // best effort; keep defaults
        console.warn('Failed to load admin profile', e);
    }
}

// Open status-only modal and populate values
function openStatusModal(customer) {
    const modal = document.getElementById('statusModal');
    const idEl = document.getElementById('status_id');
    const activeEl = document.getElementById('status_is_active');
    if (!modal || !idEl || !activeEl) return;
    idEl.value = customer.id;
    activeEl.checked = !!customer.is_active;
    modal.style.display = 'block';
}

// Build notification list UI inside the dropdown
function renderNotificationList(notifications) {
    const list = document.getElementById('notificationList');
    if (!list) return;

    if (!notifications || notifications.length === 0) {
        list.innerHTML = '<div class="no-notifications">No notifications</div>';
        return;
    }

    const itemHtml = notifications.map(n => {
        const icon = n.type === 'booking' ? 'üì¶' : (n.type === 'shipment' ? 'üöö' : 'üí¨');
        const unreadClass = n.is_read ? '' : ' unread';
        const time = n.created_at_human || n.created_at;
        const timeTitle = n.created_at_iso ? formatLocalTime(n.created_at_iso) : '';
        return `
            <div class="notification-item${unreadClass}" data-id="${n.id}">
                <div class="notification-icon">${icon}</div>
                <div class="notification-text">
                    <div class="notification-title">${n.title}</div>
                    <div class="notification-message">${n.message}</div>
                    <div class="notification-time" title="${timeTitle}">${time}</div>
                </div>
            </div>
        `;
    }).join('');

    list.innerHTML = itemHtml;
}

// Fetch notifications and populate dropdown list
function loadNotificationsList() {
    const list = document.getElementById('notificationList');
    if (list) list.innerHTML = '<div class="loading-notifications">Loading notifications...</div>';
    return fetch('/api/notifications?only=unread&limit=5&max_age_hours=24')
        .then(r => r.json())
        .then(data => {
            updateNotificationBadge(data.unread_count || 0);
            renderNotificationList(data.notifications || []);
        })
        .catch(err => {
            console.error('Error loading notifications:', err);
            if (list) list.innerHTML = '<div class="error">Failed to load notifications</div>';
        });
}

// Function to load section content
async function loadSection(section) {
    try {
        // Show loading state
        const mainContent = document.querySelector('.dashboard-main');
        mainContent.innerHTML = '<div class="loading">Loading...</div>';
        
        // Remove active class from all nav items
        document.querySelectorAll('.nav-item').forEach(item => {
            item.classList.remove('active');
        });
        
        // Add active class to current nav item
        const activeNavItem = document.querySelector(`.nav-link[data-section="${section}"]`).parentElement;
        if (activeNavItem) {
            activeNavItem.classList.add('active');
        }
        
        // Store current section in URL
        window.history.pushState({ section }, '', `/${section}`);
        
        // Load section content
        const response = await fetch(`/section/${section}`);
        if (!response.ok) throw new Error('Failed to load section');
        
        const html = await response.text();
        mainContent.innerHTML = html;
        
    } catch (error) {
        console.error('Error loading section:', error);
        showFlashMessage('Failed to load section. Please try again.', 'error');
    }
}

// Handle browser back/forward buttons
window.addEventListener('popstate', (event) => {
    if (event.state && event.state.section) {
        loadSection(event.state.section);
    }
});

// Sidebar navigation: navigate to href for real links, ignore placeholders
document.querySelector('.sidebar-nav').addEventListener('click', (e) => {
    const navLink = e.target.closest('.nav-link');
    if (!navLink) return;
    const href = navLink.getAttribute('href');
    const isPlaceholder = !href || href === '#';
    if (isPlaceholder) {
        e.preventDefault();
        return;
    }
    // allow default navigation, but ensure SPA handlers don't block
    e.preventDefault();
    window.location.href = href;
});

// Event delegation for action buttons
document.addEventListener('click', function(event) {
    const button = event.target.closest('.action-btn');
    if (!button) return;
    
    const actionsCell = button.closest('.actions-info');
    if (!actionsCell) return;
    
    const customerId = actionsCell.dataset.customerId;
    if (!customerId) return;
    
    const action = button.dataset.action;
    
    switch(action) {
        case 'view':
            viewCustomer(parseInt(customerId, 10));
            break;
        case 'edit':
            editCustomer(parseInt(customerId, 10));
            break;
        case 'delete':
            deleteCustomer(parseInt(customerId, 10));
            break;
    }
});

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    // Update date/time immediately and then every second
    updateDateTime();
    setInterval(updateDateTime, 1000);
    
    // Cache frequently used DOM refs early
    const statusSaveBtn = document.getElementById('statusSaveBtn');

    // Load notifications
    loadNotificationsList();
    setInterval(loadNotificationsList, 30000);
    
    // Sidebar toggle
    const sidebarToggle = document.getElementById('sidebarToggle');
    if (sidebarToggle) {
        sidebarToggle.addEventListener('click', toggleSidebar);
    }

    // Load admin profile into sidebar and dropdown
    loadAdminProfile();

    // Profile dropdown toggle
    const profileBtn = document.getElementById('profileBtn');
    const profileMenu = document.getElementById('profileMenu');
    if (profileBtn && profileMenu) {
        profileBtn.addEventListener('click', function(e) {
            e.stopPropagation();
            profileMenu.classList.toggle('show');
        });
    }

    // Save status only
    if (statusSaveBtn) {
        statusSaveBtn.addEventListener('click', async () => {
            try {
                const id = document.getElementById('status_id').value;
                const isActive = document.getElementById('status_is_active').checked;
                const res = await fetch(`/api/customers/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ is_active: isActive })
                });
                const data = await res.json();
                if (!res.ok || !data.success) throw new Error(data.error || 'Failed to update status');
                // Update status badge in the table
                const row = document.querySelector(`tr[data-customer-id="${id}"]`);
                if (row) {
                    const badge = row.querySelector('.status-badge');
                    if (badge) {
                        if (isActive) {
                            badge.textContent = 'Active';
                            badge.className = 'status-badge active';
                        } else {
                            badge.textContent = 'Inactive';
                            badge.className = 'status-badge inactive';
                        }
                    }
                }
                closeStatusModal();
                showFlashMessage('Status updated', 'success');
            } catch (e) {
                console.error('Status save failed', e);
                showFlashMessage(e.message || 'Failed to update status', 'error');
            }
        });
    }

    // Define edit and delete helpers
    window.editCustomer = async function(id) {
        try {
            // Fetch current customer to populate status checkbox
            const res = await fetch(`/api/customers/${id}`);
            const data = await res.json();
            const c = data && data.customer ? data.customer : data;
            const modal = document.getElementById('statusModal');
            const idEl = document.getElementById('status_id');
            const activeEl = document.getElementById('status_is_active');
            if (!modal || !idEl || !activeEl) return;
            idEl.value = id;
            activeEl.checked = !!(c && c.is_active);
            modal.classList.add('show');
            modal.style.display = 'flex';
        } catch (e) {
            console.error('editCustomer failed', e);
            showFlashMessage('Failed to open status editor', 'error');
        }
    }

    window.deleteCustomer = async function(id) {
        try {
            const ok = window.confirm('Are you sure you want to delete this customer?');
            if (!ok) return;
            const res = await fetch(`/api/customers/${id}`, { method: 'DELETE' });
            const data = await res.json();
            if (!res.ok || !data.success) throw new Error(data.error || 'Failed to delete');
            // Remove row from table
            const row = document.querySelector(`tr[data-customer-id="${id}"]`);
            if (row) row.remove();
            showFlashMessage('Customer deleted', 'success');
        } catch (e) {
            console.error('deleteCustomer failed', e);
            showFlashMessage(e.message || 'Failed to delete customer', 'error');
        }
    }

    // On load: set active nav item based on current location
    try {
        const currentPath = window.location.pathname;
        const links = document.querySelectorAll('.sidebar-nav .nav-link');
        let matched = false;
        links.forEach(link => {
            const href = link.getAttribute('href');
            if (!href || href === '#') return;
            const a = document.createElement('a');
            a.href = href;
            if (a.pathname === currentPath) {
                document.querySelectorAll('.sidebar-nav .nav-item').forEach(i => i.classList.remove('active'));
                link.parentElement.classList.add('active');
                matched = true;
            }
        });
        if (!matched) {
            // keep template default
        }
    } catch (e) { /* no-op */ }
    
    // Close modal and dropdowns when clicking outside
    window.addEventListener('click', function(event) {
        const modal = document.getElementById('customerModal');
        const adminProfileModal = document.getElementById('adminProfileModal');
        const statusModal = document.getElementById('statusModal');
        const addCustomerModalEl = document.getElementById('addCustomerModal');
        if (event.target === modal) {
            closeModal();
        }
        if (event.target === adminProfileModal) {
            closeAdminProfileModal();
        }
        if (event.target === statusModal) {
            closeStatusModal();
        }
        if (event.target === addCustomerModalEl) {
            closeAddCustomerModal();
        }

        // Close notification dropdown when clicking outside
        const menu = document.getElementById('notificationMenu');
        const btn = document.getElementById('notificationBtn');
        if (menu && btn && !menu.contains(event.target) && !btn.contains(event.target)) {
            menu.classList.remove('show');
        }

        // Close profile dropdown when clicking outside
        const pm = document.getElementById('profileMenu');
        const pb = document.getElementById('profileBtn');
        if (pm && pb && !pm.contains(event.target) && !pb.contains(event.target)) {
            pm.classList.remove('show');
        }
    });

    // Notification dropdown toggle and actions
    const notificationBtn = document.getElementById('notificationBtn');
    const notificationMenu = document.getElementById('notificationMenu');
    const markAllReadBtn = document.getElementById('markAllReadBtn');
    const viewAllBtn = document.querySelector('.notification-footer .view-all-btn');

    if (notificationBtn && notificationMenu) {
        notificationBtn.addEventListener('click', async () => {
            const isVisible = notificationMenu.classList.contains('show');
            if (isVisible) {
                notificationMenu.classList.remove('show');
            } else {
                // Show with loading state and fetch fresh
                notificationMenu.classList.add('show');
                const list = document.getElementById('notificationList');
                if (list) list.innerHTML = '<div class="loading-notifications">Loading notifications...</div>';
                await loadNotificationsList();
            }
        });
    }

    // Edit customer submit
    const editForm = document.getElementById('editCustomerForm');
    const updateBtn = document.getElementById('updateCustomerBtn');
    if (editForm && updateBtn) {
        editForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            try {
                updateBtn.disabled = true;
                const id = document.getElementById('edit_id').value;
                const payload = {
                    first_name: document.getElementById('edit_first_name').value.trim(),
                    last_name: document.getElementById('edit_last_name').value.trim(),
                    email: document.getElementById('edit_email').value.trim(),
                    phone: document.getElementById('edit_phone').value.trim(),
                    address: document.getElementById('edit_address').value.trim(),
                    city: document.getElementById('edit_city').value.trim(),
                    state: document.getElementById('edit_state').value.trim(),
                    postal_code: document.getElementById('edit_postal_code').value.trim(),
                    country: document.getElementById('edit_country').value.trim(),
                    is_active: document.getElementById('edit_is_active').checked
                };
                const res = await fetch(`/api/customers/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const data = await res.json();
                if (!res.ok || !data.success) {
                    throw new Error(data.error || 'Failed to update customer');
                }
                // Update the row in the table
                const row = document.querySelector(`tr[data-customer-id="${id}"]`);
                if (row) {
                    row.querySelector('.customer-name').textContent = `${payload.first_name} ${payload.last_name}`.trim();
                    row.querySelector('.contact-email').textContent = payload.email;
                    row.querySelector('.contact-phone').textContent = payload.phone || 'No phone';
                    const addr = [payload.address, payload.city, payload.state, payload.postal_code, payload.country].filter(Boolean).join(', ');
                    const loc = row.querySelector('.location-full');
                    if (loc) loc.textContent = addr || 'Not provided';
                    const badge = row.querySelector('.status-badge');
                    if (badge) {
                        if (payload.is_active) {
                            badge.textContent = 'Active';
                            badge.className = 'status-badge active';
                        } else {
                            badge.textContent = 'Inactive';
                            badge.className = 'status-badge inactive';
                        }
                    }
                }
                closeEditCustomerModal();
                showFlashMessage('Customer updated successfully', 'success');
            } catch (err) {
                console.error('Update customer error:', err);
                showFlashMessage(err.message || 'Failed to update customer', 'error');
            } finally {
                updateBtn.disabled = false;
            }
        });
    }

    // (Removed duplicate profile dropdown toggle here; handled above with direct class toggle)

    // Open Admin Profile modal from dropdown
    const openAdminProfileModalBtn = document.getElementById('openAdminProfileModal');
    if (openAdminProfileModalBtn) {
        openAdminProfileModalBtn.addEventListener('click', (e) => {
            e.preventDefault();
            const modal = document.getElementById('adminProfileModal');
            if (modal) modal.style.display = 'block';
            if (profileMenu) profileMenu.classList.remove('show');
        });
    }

    if (markAllReadBtn) {
        markAllReadBtn.addEventListener('click', async () => {
            try {
                // simple in-flight feedback
                const originalText = markAllReadBtn.textContent;
                markAllReadBtn.textContent = 'Marking...';
                markAllReadBtn.classList.add('disabled');
                markAllReadBtn.setAttribute('aria-busy', 'true');

                const res = await fetch('/api/notifications/mark-all-read', { method: 'POST' });
                const data = await res.json();
                if (data.success) {
                    // Clear the list and reset badge
                    renderNotificationList([]);
                    updateNotificationBadge(0);
                    // Close the dropdown to remove any visible details
                    if (notificationMenu) {
                        notificationMenu.classList.remove('show');
                    }
                }

                // restore button
                markAllReadBtn.textContent = originalText;
                markAllReadBtn.classList.remove('disabled');
                markAllReadBtn.removeAttribute('aria-busy');
            } catch (e) {
                console.error('Error marking all notifications as read:', e);
                // restore button
                markAllReadBtn.classList.remove('disabled');
                markAllReadBtn.removeAttribute('aria-busy');
            }
        });
    }

    if (viewAllBtn) {
        viewAllBtn.addEventListener('click', () => {
            window.location.href = '/notifications';
        });
    }
    
    // Open Add Customer modal
    const openAddBtn = document.getElementById('openAddCustomerBtn');
    const addCustomerModal = document.getElementById('addCustomerModal');
    const addCustomerForm = document.getElementById('addCustomerForm');
    const saveBtn = document.getElementById('saveCustomerBtn');

    if (openAddBtn) {
        openAddBtn.addEventListener('click', () => {
            if (addCustomerModal) addCustomerModal.classList.add('show');
        });
    }

    if (addCustomerForm) {
        addCustomerForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!saveBtn) return;
            try {
                saveBtn.disabled = true;
                const formData = new FormData(addCustomerForm);
                // Convert to plain object
                const payload = Object.fromEntries(formData.entries());
                // Parse status dropdown value ('true' | 'false')
                const activeVal = formData.get('is_active');
                payload.is_active = (activeVal === 'true');

                const res = await fetch('/api/customers', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const data = await res.json();
                if (!res.ok || !data.success) {
                    throw new Error(data.error || 'Failed to create customer');
                }
                showFlashMessage('Customer created successfully', 'success');
                // Close modal and refresh the page to reflect new data/pagination
                closeAddCustomerModal();
                // Wait briefly so the toast is visible before reload
                setTimeout(() => window.location.reload(), 800);
            } catch (err) {
                console.error('Add customer error:', err);
                showFlashMessage(err.message || 'Failed to create customer', 'error');
            } finally {
                saveBtn.disabled = false;
            }
        });
    }
    
    // Note: This page is server-rendered for the Users section; no SPA section loading here.
});
</script>
</body>
</html>
