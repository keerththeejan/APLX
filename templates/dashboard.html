<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
</head>
<body class="dashboard-body">
    <div class="dashboard-layout">
        <!-- Sidebar -->
        <aside class="dashboard-sidebar">
            <div class="sidebar-header">
                <div class="logo">
                    <span class="logo-icon">üöö</span>
                    <span class="logo-text">Admin Panel</span>
                </div>
            </div>
            
            <nav class="sidebar-nav">
                <ul class="nav-menu">
                    <li class="nav-item active">
                        <a href="{{ url_for('dashboard') }}" class="nav-link">
                            <span class="nav-icon">üìä</span>
                            <span class="nav-text">Dashboard</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="{{ url_for('users') }}" class="nav-link">
                            <span class="nav-icon">üë•</span>
                            <span class="nav-text">Users</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="{{ url_for('shipments') }}" class="nav-link">
                            <span class="nav-icon">üì¶</span>
                            <span class="nav-text">Shipments</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="/admin/content" class="nav-link">
                            <span class="nav-icon">üß©</span>
                            <span class="nav-text">Content</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="{{ url_for('bookings') }}" class="nav-link">
                            <span class="nav-icon">üé´</span>
                            <span class="nav-text">Bookings</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="{{ url_for('analytics_page') }}" class="nav-link">
                            <span class="nav-icon">üìà</span>
                            <span class="nav-text">Analytics</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="{{ url_for('settings') }}" class="nav-link">
                            <span class="nav-icon">‚öôÔ∏è</span>
                            <span class="nav-text">Settings</span>
                        </a>
                    </li>
                </ul>
            </nav>
            
            <div class="sidebar-footer">
                <div class="user-profile">
                    <div class="user-avatar" id="profileAvatar">A</div>
                    <div class="user-info">
                        <div class="user-name" id="profileName">Admin</div>
                        <div class="user-role"><span id="profileEmail">Administrator</span></div>
                    </div>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="dashboard-main">
            <!-- Top Header -->
            <header class="dashboard-header">
                <div class="header-left">
                    <button class="sidebar-toggle" id="sidebarToggle">
                        <span></span>
                        <span></span>
                        <span></span>
                    </button>
                    <h1>Dashboard</h1>
                </div>
                <div class="header-right">
                    <div class="datetime-display">
                        <span id="current-date"></span>
                        <span id="current-time"></span>
                        <span id="current-day"></span>
                    </div>
                    <div class="header-actions">
                        <div class="notification-dropdown">
                            <button class="notification-btn" id="notificationBtn">
                                üîî
                                <span class="notification-badge" id="notificationBadge" style="display: none;">0</span>
                            </button>
                            <div class="notification-menu" id="notificationMenu">
                                <div class="notification-header">
                                    <h3>Notifications</h3>
                                    <button class="mark-all-read-btn" id="markAllReadBtn">Mark all as read</button>
                                </div>
                                <div class="notification-list" id="notificationList">
                                    <div class="loading-notifications">Loading notifications...</div>
                                </div>
                                <div class="notification-footer">
                                    <button class="view-all-btn">View All Notifications</button>
                                </div>
                            </div>
                        </div>
                        <div class="profile-dropdown">
                            <button class="profile-btn" id="profileBtn">üë§</button>
                            <div class="profile-menu" id="profileMenu">
                                <div class="profile-header">
                                    <div class="profile-avatar-large" id="profileAvatarMenu">A</div>
                                    <div class="profile-info">
                                        <h3 id="profileNameMenu">Administrator</h3>
                                        <p id="profileEmailMenu">admin@company.com</p>
                                    </div>
                                </div>
                                <div class="profile-actions">
                                    <a class="btn" href="{{ url_for('admin_profile') }}">Edit Profile</a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </header>

            <!-- Dashboard Content -->
            <div class="dashboard-content">
        <div class="dashboard-grid">
            <!-- Statistics Cards -->
            <div class="stat-card">
                <div class="stat-icon">üìä</div>
                <div class="stat-info">
                    <h3>Total Users</h3>
                    <p class="stat-number">{{ stats.total_users }}</p>
                </div>
            </div>

            <div class="stat-card">
                <div class="stat-icon">üöö</div>
                <div class="stat-info">
                    <h3>Total Shipments</h3>
                    <p class="stat-number">{{ stats.total_shipments }}</p>
                </div>
            </div>

            <div class="stat-card">
                <div class="stat-icon">üé´</div>
                <div class="stat-info">
                    <h3>Active Bookings</h3>
                    <p class="stat-number">{{ stats.active_bookings }}</p>
                </div>
            </div>

            <div class="stat-card">
                <div class="stat-icon">üí∞</div>
                <div class="stat-info">
                    <h3>Revenue</h3>
                    <p class="stat-number">{{ stats.revenue|lkr }}</p>
                </div>
            </div>
        </div>

        <!-- Quick Actions -->
        <div class="quick-actions">
            <h3>Quick Actions</h3>
            <div class="action-buttons">
                <a class="action-btn" href="{{ url_for('users') }}">Add New User</a>
                <a class="action-btn" href="{{ url_for('shipments') }}">Manage Shipments</a>
                <a class="action-btn" href="{{ url_for('analytics_page') }}">View Reports</a>
                <a class="action-btn" href="{{ url_for('settings') }}">System Settings</a>
            </div>
        </div>

        <!-- Recent Activity -->
        <div class="recent-activity">
            <h3>Recent Activity</h3>
            <div class="activity-list">
                {% if recent_notifications and recent_notifications|length > 0 %}
                    {% for n in recent_notifications %}
                    <div class="activity-item">
                        <span class="activity-time">{{ n.created_at.strftime('%d %b %Y %I:%M %p') }}</span>
                        <span class="activity-text">{{ n.title }} ‚Äî {{ n.message }}</span>
                    </div>
                    {% endfor %}
                {% else %}
                    <div class="activity-item">
                        <span class="activity-text">No recent activity</span>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
        </main>
    </div>

<script>
// Function to update date, time, and day
function updateDateTime() {
    const now = new Date();
    
    // Format date
    const dateOptions = { 
        year: 'numeric', 
        month: 'long', 
        day: 'numeric' 
    };
    const formattedDate = now.toLocaleDateString('en-US', dateOptions);
    
    // Format time
    const timeOptions = { 
        hour: '2-digit', 
        minute: '2-digit', 
        second: '2-digit',
        hour12: true 
    };
    const formattedTime = now.toLocaleTimeString('en-US', timeOptions);
    
    // Format day
    const dayOptions = { weekday: 'long' };
    const formattedDay = now.toLocaleDateString('en-US', dayOptions);
    
    // Update the display
    document.getElementById('current-date').textContent = formattedDate;
    document.getElementById('current-time').textContent = formattedTime;
    document.getElementById('current-day').textContent = formattedDay;
}

// Sidebar toggle functionality
function toggleSidebar() {
    const sidebar = document.querySelector('.dashboard-sidebar');
    const main = document.querySelector('.dashboard-main');
    
    sidebar.classList.toggle('collapsed');
    main.classList.toggle('expanded');
}

// Profile dropdown functionality
let isEditing = false;
let currentEditField = null;

function toggleProfileMenu() {
    const profileMenu = document.getElementById('profileMenu');
    profileMenu.classList.toggle('show');
}

// Password visibility toggle functions
let passwordVisible = false;
let inputPasswordVisible = false;

function togglePasswordVisibility() {
    const passwordSpan = document.getElementById('adminPassword');
    const toggleBtn = document.querySelector('.toggle-password-btn');
    
    if (passwordVisible) {
        passwordSpan.textContent = '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢';
        toggleBtn.textContent = 'üëÅÔ∏è';
        passwordVisible = false;
    } else {
        passwordSpan.textContent = document.getElementById('adminPasswordInput').value;
        toggleBtn.textContent = 'üôà';
        passwordVisible = true;
    }
}

function toggleInputPasswordVisibility() {
    const passwordInput = document.getElementById('adminPasswordInput');
    const toggleBtn = document.querySelector('.toggle-input-password-btn');
    
    if (inputPasswordVisible) {
        passwordInput.type = 'password';
        toggleBtn.textContent = 'üëÅÔ∏è';
        inputPasswordVisible = false;
    } else {
        passwordInput.type = 'text';
        toggleBtn.textContent = 'üôà';
        inputPasswordVisible = true;
    }
}

function editField(fieldType) {
    if (isEditing) return;
    
    isEditing = true;
    currentEditField = fieldType;
    
    if (fieldType === 'password') {
        // Special handling for password field
        const detailValue = document.querySelector('.detail-item:nth-child(3) .detail-value');
        const passwordContainer = document.querySelector('.password-input-container');
        
        detailValue.style.display = 'none';
        passwordContainer.style.display = 'flex';
        document.getElementById('adminPasswordInput').focus();
    } else {
        const span = document.getElementById(`admin${fieldType.charAt(0).toUpperCase() + fieldType.slice(1)}`);
        const input = document.getElementById(`admin${fieldType.charAt(0).toUpperCase() + fieldType.slice(1)}Input`);
        
        span.style.display = 'none';
        input.style.display = 'inline-block';
        input.focus();
    }
    
    // Show save/cancel buttons
    document.getElementById('saveBtn').style.display = 'inline-block';
    document.getElementById('cancelBtn').style.display = 'inline-block';
    
    // Hide edit buttons and password toggle
    document.querySelectorAll('.edit-btn').forEach(btn => btn.style.display = 'none');
    document.querySelectorAll('.toggle-password-btn').forEach(btn => btn.style.display = 'none');
}

function saveChanges() {
    if (!currentEditField) return;
    
    const input = document.getElementById(`admin${currentEditField.charAt(0).toUpperCase() + currentEditField.slice(1)}Input`);
    const span = document.getElementById(`admin${currentEditField.charAt(0).toUpperCase() + currentEditField.slice(1)}`);
    
    let newValue = input.value.trim();
    
    if (!newValue) {
        alert('Field cannot be empty!');
        return;
    }
    
    // Update the display value
    if (currentEditField === 'password') {
        span.textContent = '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢';
    } else {
        span.textContent = newValue;
        
        // Update profile header if name or email changed
        if (currentEditField === 'name') {
            document.querySelector('.profile-info h3').textContent = newValue;
            document.querySelector('.user-name').textContent = newValue;
            document.querySelector('.user-avatar').textContent = newValue.charAt(0).toUpperCase();
            document.querySelector('.profile-avatar-large').textContent = newValue.charAt(0).toUpperCase();
        } else if (currentEditField === 'email') {
            document.querySelector('.profile-info p').textContent = newValue;
        }
    }
    
    cancelEdit();
    
    // Show success message
    showNotification('Profile updated successfully!', 'success');
}

function cancelEdit() {
    if (!currentEditField) return;
    
    if (currentEditField === 'password') {
        // Special handling for password field
        const detailValue = document.querySelector('.detail-item:nth-child(3) .detail-value');
        const passwordContainer = document.querySelector('.password-input-container');
        
        detailValue.style.display = 'flex';
        passwordContainer.style.display = 'none';
        
        // Reset password input type and visibility
        document.getElementById('adminPasswordInput').type = 'password';
        document.querySelector('.toggle-input-password-btn').textContent = 'üëÅÔ∏è';
        inputPasswordVisible = false;
    } else {
        const span = document.getElementById(`admin${currentEditField.charAt(0).toUpperCase() + currentEditField.slice(1)}`);
        const input = document.getElementById(`admin${currentEditField.charAt(0).toUpperCase() + currentEditField.slice(1)}Input`);
        
        span.style.display = 'inline-block';
        input.style.display = 'none';
    }
    
    // Hide save/cancel buttons
    document.getElementById('saveBtn').style.display = 'none';
    document.getElementById('cancelBtn').style.display = 'none';
    
    // Show edit buttons and password toggle
    document.querySelectorAll('.edit-btn').forEach(btn => btn.style.display = 'inline-block');
    document.querySelectorAll('.toggle-password-btn').forEach(btn => btn.style.display = 'inline-block');
    
    isEditing = false;
    currentEditField = null;
}

function logout() {
    if (confirm('Are you sure you want to logout?')) {
        showNotification('Logging out...', 'info');
        setTimeout(() => {
            window.location.href = '/';
        }, 1500);
    }
}

function showNotification(message, type) {
    const notification = document.createElement('div');
    notification.className = `notification ${type}`;
    notification.textContent = message;
    
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.classList.add('show');
    }, 100);
    
    setTimeout(() => {
        notification.classList.remove('show');
        setTimeout(() => {
            document.body.removeChild(notification);
        }, 300);
    }, 3000);
}

// Notification functions
function loadNotifications() {
    const params = new URLSearchParams({ only: 'unread', limit: '5', max_age_hours: '24' });
    fetch(`/api/notifications?${params.toString()}`)
        .then(response => response.json())
        .then(data => {
            updateNotificationBadge(data.unread_count);
            displayNotifications(data.notifications);
        })
        .catch(error => {
            console.error('Error loading notifications:', error);
            document.getElementById('notificationList').innerHTML = '<div class="error-message">Failed to load notifications</div>';
        });
}

function updateNotificationBadge(count) {
    const badge = document.getElementById('notificationBadge');
    if (count > 0) {
        badge.textContent = count > 99 ? '99+' : count;
        badge.style.display = 'block';
    } else {
        badge.style.display = 'none';
    }
}

function formatLocalTime(isoString) {
    try {
        const d = new Date(isoString);
        return d.toLocaleString(undefined, { year: 'numeric', month: 'short', day: '2-digit', hour: '2-digit', minute: '2-digit' });
    } catch { return ''; }
}

function displayNotifications(notifications) {
    const notificationList = document.getElementById('notificationList');
    
    if (notifications.length === 0) {
        notificationList.innerHTML = '<div class="no-notifications">No notifications</div>';
        return;
    }
    
    let html = '';
    notifications.forEach(notification => {
        const timeAgo = notification.created_at_human || getTimeAgo(new Date(notification.created_at));
        const typeIcon = getNotificationIcon(notification.type);
        const timeTitle = notification.created_at_iso ? formatLocalTime(notification.created_at_iso) : '';
        
        html += `
            <div class="notification-item ${notification.is_read ? 'read' : 'unread'}" data-id="${notification.id}">
                <div class="notification-icon">${typeIcon}</div>
                <div class="notification-content">
                    <div class="notification-title">${notification.title}</div>
                    <div class="notification-message">${notification.message}</div>
                    <div class="notification-time" title="${timeTitle}">${timeAgo}</div>
                </div>
                ${!notification.is_read ? '<div class="unread-dot"></div>' : ''}
            </div>
        `;
    });
    
    notificationList.innerHTML = html;
    
    // Add click handlers for notifications
    document.querySelectorAll('.notification-item').forEach(item => {
        item.addEventListener('click', function() {
            const notificationId = this.dataset.id;
            markNotificationAsRead(notificationId);
        });
    });
}

function getNotificationIcon(type) {
    switch(type) {
        case 'booking': return 'üì¶';
        case 'shipment': return 'üöö';
        case 'message': return 'üí¨';
        default: return 'üîî';
    }
}

function getTimeAgo(date) {
    const now = new Date();
    const diffInSeconds = Math.floor((now - date) / 1000);
    
    if (diffInSeconds < 60) return 'Just now';
    if (diffInSeconds < 3600) return `${Math.floor(diffInSeconds / 60)}m ago`;
    if (diffInSeconds < 86400) return `${Math.floor(diffInSeconds / 3600)}h ago`;
    return `${Math.floor(diffInSeconds / 86400)}d ago`;
}

function markNotificationAsRead(notificationId) {
    fetch(`/api/notifications/${notificationId}/read`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            loadNotifications(); // Reload to update badge and styling
        }
    })
    .catch(error => console.error('Error marking notification as read:', error));
}

function markAllNotificationsAsRead() {
    fetch('/api/notifications/mark-all-read', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            loadNotifications(); // Reload to update badge and styling
            showNotification('All notifications marked as read', 'success');
        }
    })
    .catch(error => console.error('Error marking all notifications as read:', error));
}

function toggleNotificationMenu() {
    const notificationMenu = document.getElementById('notificationMenu');
    const isVisible = notificationMenu.classList.contains('show');
    
    if (!isVisible) {
        loadNotifications(); // Load fresh data when opening
    }
    
    notificationMenu.classList.toggle('show');
}

// Load admin profile info into sidebar footer and profile dropdown
async function loadAdminProfile() {
    try {
        const res = await fetch('/api/admin/profile');
        const data = await res.json();
        if (data && (data.name !== undefined)) {
            const name = (data.name || '').trim() || 'Admin';
            const email = data.email || '';
            const avatarChar = (name ? name[0] : 'A').toUpperCase();

            // Sidebar footer
            const sName = document.getElementById('profileName');
            const sEmail = document.getElementById('profileEmail');
            const sAvatar = document.getElementById('profileAvatar');
            if (sName) sName.textContent = name;
            if (sEmail) sEmail.textContent = email || 'Administrator';
            if (sAvatar) sAvatar.textContent = avatarChar;

            // Dropdown header
            const dName = document.getElementById('profileNameMenu');
            const dEmail = document.getElementById('profileEmailMenu');
            const dAvatar = document.getElementById('profileAvatarMenu');
            if (dName) dName.textContent = name;
            if (dEmail) dEmail.textContent = email;
            if (dAvatar) dAvatar.textContent = avatarChar;
        }
    } catch (e) {
        // ignore; keep defaults
        console.warn('Failed to load admin profile', e);
    }
}

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    // Update date/time immediately and then every second
    updateDateTime();
    setInterval(updateDateTime, 1000);
    
    // Load notifications initially
    loadNotifications();
    
    // Refresh notifications every 30 seconds
    setInterval(loadNotifications, 30000);
    
    // Sidebar toggle
    const sidebarToggle = document.getElementById('sidebarToggle');
    if (sidebarToggle) {
        sidebarToggle.addEventListener('click', toggleSidebar);
    }
    
    // Notification dropdown toggle
    const notificationBtn = document.getElementById('notificationBtn');
    if (notificationBtn) {
        notificationBtn.addEventListener('click', function(e) {
            e.stopPropagation();
            toggleNotificationMenu();
        });
    }
    
    // Mark all as read button
    const markAllReadBtn = document.getElementById('markAllReadBtn');
    if (markAllReadBtn) {
        markAllReadBtn.addEventListener('click', function(e) {
            e.stopPropagation();
            markAllNotificationsAsRead();
        });
    }
    
    // Profile dropdown toggle
    const profileBtn = document.getElementById('profileBtn');
    if (profileBtn) {
        profileBtn.addEventListener('click', function(e) {
            e.stopPropagation();
            toggleProfileMenu();
        });
    }
    
    // Close menus when clicking outside
    document.addEventListener('click', function(e) {
        const profileDropdown = document.querySelector('.profile-dropdown');
        const notificationDropdown = document.querySelector('.notification-dropdown');
        
        if (!profileDropdown.contains(e.target)) {
            document.getElementById('profileMenu').classList.remove('show');
        }
        
        if (!notificationDropdown.contains(e.target)) {
            document.getElementById('notificationMenu').classList.remove('show');
        }
    });
    
    // Navigation active state
    const navLinks = document.querySelectorAll('.nav-link');
    navLinks.forEach(link => {
        link.addEventListener('click', function(e) {
            const href = this.getAttribute('href');
            const isPlaceholder = !href || href === '#';

            if (isPlaceholder) {
                e.preventDefault();
            }
            
            // Remove active class from all items
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            
            // Add active class to clicked item
            this.parentElement.classList.add('active');

            // Navigate for real links
            if (!isPlaceholder) {
                // allow default navigation behavior
                // In case some browsers still need explicit navigation due to preventions elsewhere
                window.location.href = href;
            }
        });
    });

    // Load admin profile details
    loadAdminProfile();

    // Set active nav item based on current path on load
    try {
        const currentPath = window.location.pathname;
        let matched = false;
        navLinks.forEach(link => {
            const href = link.getAttribute('href');
            if (href && href !== '#') {
                const a = document.createElement('a');
                a.href = href;
                if (a.pathname === currentPath) {
                    document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
                    link.parentElement.classList.add('active');
                    matched = true;
                }
            }
        });
        if (!matched) {
            // keep existing default active
        }
    } catch (e) { /* no-op */ }
    
    // Handle Enter key in edit inputs
    document.querySelectorAll('.edit-input').forEach(input => {
        input.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                saveChanges();
            } else if (e.key === 'Escape') {
                cancelEdit();
            }
        });
    });
});
</script>
</body>
</html>