<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Analytics</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
  <!-- Chart.js CDN -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
</head>
<body class="dashboard-body">
  <div class="dashboard-layout">
    <!-- Sidebar -->
    <aside class="dashboard-sidebar">
      <div class="sidebar-header">
        <div class="logo">
          <span class="logo-icon">ğŸšš</span>
          <span class="logo-text">Admin Panel</span>
        </div>
      </div>
      <nav class="sidebar-nav">
        <ul class="nav-menu">
          <li class="nav-item">
            <a href="{{ url_for('dashboard') }}" class="nav-link">
              <span class="nav-icon">ğŸ“Š</span><span class="nav-text">Dashboard</span>
            </a>
          </li>
          <li class="nav-item">
            <a href="{{ url_for('users') }}" class="nav-link">
              <span class="nav-icon">ğŸ‘¥</span><span class="nav-text">Users</span>
            </a>
          </li>
          <li class="nav-item">
            <a href="{{ url_for('shipments') }}" class="nav-link">
              <span class="nav-icon">ğŸ“¦</span><span class="nav-text">Shipments</span>
            </a>
          </li>
          <li class="nav-item">
            <a href="{{ url_for('admin_content_manager') }}" class="nav-link">
              <span class="nav-icon">ğŸ§©</span><span class="nav-text">Content</span>
            </a>
          </li>
          <li class="nav-item">
            <a href="{{ url_for('bookings') }}" class="nav-link">
              <span class="nav-icon">ğŸ«</span><span class="nav-text">Bookings</span>
            </a>
          </li>
          <li class="nav-item active">
            <a href="{{ url_for('analytics_page') }}" class="nav-link">
              <span class="nav-icon">ğŸ“ˆ</span><span class="nav-text">Analytics</span>
            </a>
          </li>
          <li class="nav-item">
            <a href="{{ url_for('settings') }}" class="nav-link"><span class="nav-icon">âš™ï¸</span><span class="nav-text">Settings</span></a>
          </li>
        </ul>
      </nav>
      <div class="sidebar-footer">
        <div class="user-profile">
          <div class="user-avatar" id="profileAvatar">A</div>
          <div class="user-info">
            <div class="user-name" id="profileName">Admin</div>
            <div class="user-role"><span id="profileEmail">admin@company.com</span></div>
          </div>
        </div>
      </div>
    </aside>

    <!-- Main -->
    <main class="dashboard-main">
      <header class="dashboard-header">
        <div class="header-left">
          <button class="sidebar-toggle" id="sidebarToggle"><span></span><span></span><span></span></button>
          <h1>Analytics</h1>
        </div>
        <div class="header-right">
          <div class="datetime-display">
            <span id="current-date"></span>
            <span id="current-time"></span>
            <span id="current-day"></span>
          </div>
          <div class="header-actions">
            <div class="notification-dropdown">
              <button class="notification-btn" id="notificationBtn">ğŸ””
                <span class="notification-badge" id="notificationBadge" style="display:none;">0</span>
              </button>
              <div class="notification-menu" id="notificationMenu">
                <div class="notification-header">
                  <h3>Notifications</h3>
                  <button class="mark-all-read-btn" id="markAllReadBtn">Mark all as read</button>
                </div>
                <div class="notification-list" id="notificationList">
                  <div class="loading-notifications">Loading notifications...</div>
                </div>
                <div class="notification-footer">
                  <button class="view-all-btn" id="viewAllNotificationsBtn">View All Notifications</button>
                </div>
              </div>
            </div>

            <div class="profile-dropdown">
              <button class="profile-btn" id="profileBtn">ğŸ‘¤</button>
              <div class="profile-menu" id="profileMenu">
                <div class="profile-header">
                  <div class="profile-avatar-large" id="profileAvatarMenu">A</div>
                  <div class="profile-info">
                    <h3 id="profileNameMenu">Administrator</h3>
                    <p id="profileEmailMenu">admin@company.com</p>
                  </div>
                </div>
                <div class="profile-actions">
                  <a class="btn" href="{{ url_for('admin_profile') }}">Edit Profile</a>
                </div>
              </div>
            </div>
          </div>
        </div>
      </header>

      <div class="dashboard-content">
        <!-- Cards -->
        <div class="users-stats" style="margin-bottom:12px;">
          <div class="stat-item">
            <div class="stat-icon">ğŸšš</div>
            <span class="stat-number" id="shipmentsTotal">0</span>
            <span class="stat-label">Total Shipments</span>
          </div>
          <div class="stat-item">
            <div class="stat-icon">ğŸ«</div>
            <span class="stat-number" id="bookingsTotal">0</span>
            <span class="stat-label">Total Bookings</span>
          </div>
          <div class="stat-item">
            <div class="stat-icon">ğŸ’°</div>
            <span class="stat-number" id="revenueTotal">Rs 0.00</span>
            <span class="stat-label">Revenue</span>
          </div>
        </div>

        <!-- Charts -->
        <div class="card">
          <h3>Shipments (Last 12 months)</h3>
          <canvas id="shipmentsChart" height="120"></canvas>
        </div>

        <div class="card">
          <h3>Bookings (Last 12 months)</h3>
          <canvas id="bookingsChart" height="120"></canvas>
        </div>
      </div>
    </main>
  </div>

  <script>
  // Sidebar toggle
  function toggleSidebar(){
    const s=document.querySelector('.dashboard-sidebar');
    const m=document.querySelector('.dashboard-main');
    s.classList.toggle('collapsed'); m.classList.toggle('expanded');
  }

  // Date/time
  function updateDateTime(){
    try{
      const now=new Date();
      const dateOptions={year:'numeric',month:'long',day:'numeric'};
      const timeOptions={hour:'2-digit',minute:'2-digit',second:'2-digit',hour12:true};
      const dayOptions={weekday:'long'};
      const elDate=document.getElementById('current-date');
      const elTime=document.getElementById('current-time');
      const elDay=document.getElementById('current-day');
      if(elDate) elDate.textContent=now.toLocaleDateString('en-US',dateOptions);
      if(elTime) elTime.textContent=now.toLocaleTimeString('en-US',timeOptions);
      if(elDay) elDay.textContent=now.toLocaleDateString('en-US',dayOptions);
    }catch(e){}
  }

  // Profile dropdown
  function bindProfileDropdown(){
    const btn=document.getElementById('profileBtn');
    const menu=document.getElementById('profileMenu');
    if(btn && menu){
      btn.addEventListener('click', (e)=>{ e.stopPropagation(); menu.classList.toggle('show'); });
    }
  }

  // Notifications dropdown (green style already in CSS)
  function bindNotifications(){
    const btn=document.getElementById('notificationBtn');
    const menu=document.getElementById('notificationMenu');
    const markAll=document.getElementById('markAllReadBtn');
    const viewAll=document.getElementById('viewAllNotificationsBtn');
    function updateBadge(count){
      const badge=document.getElementById('notificationBadge');
      if(!badge) return;
      if(count>0){ badge.textContent=count>99?'99+':count; badge.style.display='block'; }
      else { badge.style.display='none'; }
    }
    async function loadList(){
      try{
        const res=await fetch('/api/notifications');
        const data=await res.json();
        updateBadge(data.unread_count||0);
        const list=document.getElementById('notificationList');
        const items=data.notifications||[];
        if(!items.length){ list.innerHTML='<div class="no-notifications">No notifications</div>'; return; }
        list.innerHTML=items.map(n=>`
          <div class="notification-item ${n.is_read?'read':'unread'}">
            <div class="notification-icon">${n.type==='booking'?'ğŸ“¦':(n.type==='shipment'?'ğŸšš':(n.type==='message'?'ğŸ’¬':'ğŸ””'))}</div>
            <div class="notification-content">
              <div class="notification-title">${n.title}</div>
              <div class="notification-message">${n.message}</div>
              <div class="notification-time">${n.created_at_human||''}</div>
            </div>
          </div>`).join('');
      }catch(e){
        document.getElementById('notificationList').innerHTML='<div class="error">Failed to load</div>';
      }
    }
    if(btn && menu){
      btn.addEventListener('click', async (e)=>{
        e.stopPropagation();
        const visible=menu.classList.contains('show');
        if(!visible){ menu.classList.add('show'); document.getElementById('notificationList').innerHTML='<div class="loading-notifications">Loading notifications...</div>'; await loadList(); }
        else { menu.classList.remove('show'); }
      });
    }
    if(markAll){
      markAll.addEventListener('click', async (e)=>{
        e.stopPropagation();
        try{ await fetch('/api/notifications/mark-all-read', {method:'POST'}); await loadList(); }catch(e){}
      });
    }
    if(viewAll){ viewAll.addEventListener('click', ()=> window.location.href='/notifications'); }
  }

  // Close menus on outside click
  function bindGlobalClose(){
    document.addEventListener('click', (e)=>{
      const pm=document.getElementById('profileMenu');
      const pd=document.querySelector('.profile-dropdown');
      if(pm && pd && !pd.contains(e.target)) pm.classList.remove('show');
      const nm=document.getElementById('notificationMenu');
      const nd=document.querySelector('.notification-dropdown');
      if(nm && nd && !nd.contains(e.target)) nm.classList.remove('show');
    });
  }

  // Load admin profile info
  async function loadAdminProfile(){
    try{
      const res=await fetch('/api/admin/profile');
      const data=await res.json();
      if(data && (data.name!==undefined)){
        const name=(data.name||'').trim()||'Admin';
        const email=data.email||'';
        const avatar=(name?name[0]:'A').toUpperCase();
        const nameEl=document.getElementById('profileName'); if(nameEl) nameEl.textContent=name;
        const emailEl=document.getElementById('profileEmail'); if(emailEl) emailEl.textContent=email;
        const avatarEl=document.getElementById('profileAvatar'); if(avatarEl) avatarEl.textContent=avatar;
        const nameMenu=document.getElementById('profileNameMenu'); if(nameMenu) nameMenu.textContent=name;
        const emailMenu=document.getElementById('profileEmailMenu'); if(emailMenu) emailMenu.textContent=email;
        const avatarMenu=document.getElementById('profileAvatarMenu'); if(avatarMenu) avatarMenu.textContent=avatar;
      }
    }catch(e){}
  }

  // Chart helpers
  function monthLabels(len=12){
    const base=new Date();
    const labels=[];
    for(let i=len-1;i>=0;i--){
      const d=new Date(base.getFullYear(), base.getMonth()-i, 1);
      labels.push(d.toLocaleString('en-US', {month:'short', year:'2-digit'}));
    }
    return labels;
  }

  function makeBarChart(ctx, labels, values, label, color='#3b82f6'){
    return new Chart(ctx, {
      type:'bar',
      data:{ labels, datasets:[{ label, data:values, backgroundColor: color }]},
      options:{ responsive:true, plugins:{ legend:{display:true} }, scales:{ y:{ beginAtZero:true } } }
    });
  }

  function makeLineChart(ctx, labels, values, label, color='#16a34a'){
    return new Chart(ctx, {
      type:'line',
      data:{ labels, datasets:[{ label, data:values, borderColor: color, backgroundColor: color+'33', fill:true, tension:.25, pointRadius:3 }]},
      options:{ responsive:true, plugins:{ legend:{display:true} }, scales:{ y:{ beginAtZero:true } } }
    });
  }

  // Load analytics (with graceful fallback)
  async function loadAnalytics(){
    const shipmentsCtx=document.getElementById('shipmentsChart').getContext('2d');
    const bookingsCtx=document.getElementById('bookingsChart').getContext('2d');
    const labels=monthLabels(12);

    try{
      const res=await fetch('/api/analytics/summary');
      if(!res.ok) throw new Error('bad status');
      const data=await res.json();

      // Expected structure:
      // { totals: { shipments: 0, bookings: 0, revenue: 0.0 },
      //   series: { shipments: [..12], bookings: [..12] } }

      const ships=data?.series?.shipments||Array(12).fill(0);
      const books=data?.series?.bookings||Array(12).fill(0);
      const totals=data?.totals||{shipments:0, bookings:0, revenue:0};

      document.getElementById('shipmentsTotal').textContent=totals.shipments||0;
      document.getElementById('bookingsTotal').textContent=totals.bookings||0;
      document.getElementById('revenueTotal').textContent=`Rs ${(Number(totals.revenue||0)).toLocaleString('en-LK', {minimumFractionDigits:2, maximumFractionDigits:2})}`;

      makeBarChart(shipmentsCtx, labels, ships, 'Shipments / month', '#3b82f6');
      makeLineChart(bookingsCtx, labels, books, 'Bookings / month', '#16a34a');
    }catch(e){
      // Demo fallback data
      const ships=[12,18,22,19,25,30,28,24,20,26,29,31];
      const books=[9,14,17,15,19,23,21,20,18,22,25,27];
      document.getElementById('shipmentsTotal').textContent=ships.reduce((a,b)=>a+b,0);
      document.getElementById('bookingsTotal').textContent=books.reduce((a,b)=>a+b,0);
      document.getElementById('revenueTotal').textContent='Rs 0.00';
      makeBarChart(shipmentsCtx, labels, ships, 'Shipments / month', '#3b82f6');
      makeLineChart(bookingsCtx, labels, books, 'Bookings / month', '#16a34a');
    }
  }

  // Init
  document.addEventListener('DOMContentLoaded', ()=>{
    const sidebarToggle=document.getElementById('sidebarToggle');
    if(sidebarToggle) sidebarToggle.addEventListener('click', toggleSidebar);

    updateDateTime(); setInterval(updateDateTime, 1000);
    bindProfileDropdown();
    bindNotifications();
    bindGlobalClose();
    loadAdminProfile();
    loadAnalytics();
  });
  </script>
</body>
</html>